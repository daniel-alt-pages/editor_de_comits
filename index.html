<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (código HEAD existente sin cambios) ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ... (código CSS existente sin cambios) ... */
        /* Estilo para el placeholder de video */
        .video-placeholder svg {
            transition: transform 0.2s ease-in-out;
        }
        .video-placeholder:hover svg {
            transform: scale(1.1);
        }
        
        /* **** NUEVO: Estilo para los botones de archivo **** */
        .file-list-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: all 0.2s ease-in-out;
        }
        .file-list-button:hover {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); /* ring-blue-500 */
            color: #1d4ed8; /* blue-700 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="max-w-7xl mx-auto px-4 md:px-8">

        <!-- Encabezado Fijo -->
        <header class="sticky top-0 z-40 bg-gray-50/90 backdrop-blur-md pt-6 pb-4 mb-6 border-b border-gray-200 flex justify-between items-center">
            <!-- ... (código del encabezado sin cambios) ... -->
            <div>
                <h1 class="text-3xl font-bold text-blue-700">Plataforma de Administración (GitHub)</h1>
                <p id="auth-status" class="text-sm text-gray-600">Esperando token de GitHub...</p>
            </div>
            <!-- Contenedor de botones del encabezado -->
            <div class="flex items-center">
                <button id="back-to-browser-button" onclick="app.goBackToBrowser()" class="hidden px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 mr-2">
                    Cambiar Archivo
                </button>
                <button id="save-all-button" onclick="app.saveAllChanges()" class="hidden px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 mr-2" disabled>
                    Guardado
                </button>
                <button id="logout-button" onclick="app.logout()" class="hidden px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        
        <!-- 1. VISTA DE LOGIN (Sin cambios) -->
        <div id="login-view" class="hidden max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200 mt-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Iniciar Sesión</h2>
            <p class="text-gray-600 mb-6">Por favor, introduce tu <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 hover:underline">Token de Acceso Personal (PAT)</a> de GitHub. Asegúrate de que tenga permisos de `repo`.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="token-input" class="block text-sm font-medium text-gray-700 mb-1">Token de GitHub</label>
                    <input type="password" id="token-input" placeholder="ghp_..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="app.handleLogin()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    Conectar
                </button>
            </div>
        </div>
        
        <!-- 
            *** INICIO DE LA CORRECCIÓN ***
            Reorganizada la VISTA DE NAVEGADOR para un flujo más rápido.
        -->
        <!-- 2. VISTA DE NAVEGADOR DE ARCHIVOS -->
        <div id="browser-view" class="hidden max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200 mt-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Acciones del Repositorio</h2>
            
            <!-- Paso 1: Seleccionar Repositorio -->
            <div>
                <label for="repo-select" class="block text-sm font-medium text-gray-700 mb-1">Repositorio Seleccionado</label>
                <select id="repo-select" onchange="app.handleRepoChange(this.value)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <option value="">Cargando repositorios...</option>
                </select>
            </div>

            <!-- Contenedor para acciones (aparece al seleccionar repo) -->
            <div id="repo-actions-container" class="hidden mt-6 space-y-6">
            
                <!-- Subida General de Archivos -->
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Subir un Archivo</h3>
                    <p class="text-sm text-gray-500 mb-3">Sube una imagen, PDF o documento al repositorio. Se te dará un enlace para copiar y pegar en tus items.</p>
                    <button id="upload-file-button" onclick="app.triggerGeneralFileUpload()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                        </svg>
                        Subir Archivo a /uploads/
                    </button>
                </div>

                <!-- Crear Nuevo Archivo -->
                <div id="create-file-container" class="pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">O crear un nuevo archivo</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-file-name" placeholder="ej: datos/nuevo.json" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="create-file-button" onclick="app.createNewFile()" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400" disabled>
                            Crear
                        </button>
                    </div>
                </div>

                <!-- Lista de Archivos Existentes -->
                <div id="file-list-section" class="pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">O abrir un archivo existente</h3>
                    <div id="file-list-container" class="space-y-2">
                        <!-- JS renderizará los botones aquí -->
                        <p id="file-list-loading" class="text-gray-500">Selecciona un repositorio para ver los archivos...</p>
                    </div>
                </div>

            </div>
        </div>
        <!-- *** FIN DE LA CORRECCIÓN *** -->
        
        <!-- 3. INDICADOR DE CARGA GLOBAL -->
        <div id="loading-spinner" class="hidden text-center p-10">
            <p class="text-lg font-medium text-blue-600">Cargando...</p>
        </div>

        <!-- 4. VISTA DE EDITOR (El <main> SÍ existía) -->
        <main id="app-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Pestañas (si aplica) -->
            <div id="tabs-container" class="lg:col-span-3 flex flex-wrap gap-2 mb-2">
                <!-- Pestañas generadas por JS -->
            </div>
            
            <!-- Columna Izquierda/Principal: Lista de Items -->
            <section class="lg:col-span-2">
                
                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
                    <h2 id="items-list-title" class="text-2xl font-semibold text-gray-800">Items</h2>
                    
                    <div class="flex items-center gap-2">
                        <!-- NUEVA FUNCIONALIDAD: Barra de Búsqueda -->
                        <div class="relative flex-grow">
                            <input type="search" id="search-bar" oninput="app.renderItemsList()" placeholder="Buscar items..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <!-- NUEVO: Botón de Importar (Reemplazo masivo) -->
                        <button id="import-local-button" onclick="app.triggerImportModal()" class="hidden p-2 bg-white text-blue-600 rounded-md shadow-sm border border-gray-300 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Importar desde local (Reemplaza datos JSON/CSV)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <!-- **** CORRECCIÓN: El botón de subida general ya no está aquí, se movió a la vista de "browser" **** -->
                        
                        <!-- NUEVA FUNCIONALIDAD: Botón de Administrar Campos -->
                        <button id="schema-manager-button" onclick="app.showSchemaModal()" class="hidden p-2 bg-white text-gray-600 rounded-md shadow-sm border border-gray-300 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Administrar Campos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM17 8a1 1 0 10-2 0v.268a2 2 0 000 3.464V16a1 1 0 102 0v-4.268a2 2 0 000-3.464V8z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="items-list">
                    <!-- Los items se generan con JavaScript en un grid -->
                </div>
            </section>

            <!-- Columna Derecha/Lateral: Formulario de Añadir -->
            <section id="add-item-form-container" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 h-fit lg:sticky lg:top-28">
                <!-- El formulario se genera con JavaScript -->
            </section>
        </main>
    </div>

    <!-- MODALES (sin cambios) -->
    <!-- ... (Modal de Edición) ... -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="edit-modal-title" class="text-xl font-semibold text-gray-800">Editar Item</h3>
                <button id="edit-modal-close" onclick="app.hideEditModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-form" class="space-y-4">
                <!-- Contenido generado por JS -->
            </form>
        </div>
    </div>
    <!-- ... (Modal de Confirmación) ... -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="confirm-modal-title" class="text-xl font-semibold text-gray-800">Confirmar</h3>
                <button id="confirm-modal-close" onclick="app.hideConfirmModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <!-- **** CORRECCIÓN: Añadido estilo para preservar saltos de línea en el mensaje **** -->
            <p id="confirm-modal-message" class="text-gray-600 mb-4 whitespace-pre-wrap">¿Estás seguro?</p>
            <p id="confirm-modal-note" class="text-sm text-red-600 mb-6 hidden">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-modal-cancel" onclick="app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="confirm-modal-accept-btn" class="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">Sí, Confirmar</button>
            </div>
        </div>
    </div>
    <!-- ... (Modal de Schema) ... -->
    <div id="schema-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Administrar Campos</h3>
                <button id="schema-modal-close" onclick="app.hideSchemaModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Añade un nuevo campo a **todos** los items de este archivo. Si el campo ya existe en un item, no será modificado.</p>
            <form id="schema-form" class="space-y-4">
                <div>
                    <label for="new-field-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Nuevo Campo</label>
                    <input type="text" id="new-field-name" placeholder="ej: autor" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="new-field-default-value" class="block text-sm font-medium text-gray-700 mb-1">Valor por Defecto</label>
                    <input type="text" id="new-field-default-value" placeholder="ej: N/A" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="app.hideSchemaModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Añadir Campo a Todos</button>
                </div>
            </form>
        </div>
    </div>
    <!-- ... (Modal de Revisión de Cambios) ... -->
    <div id="review-changes-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Revisar Cambios Pendientes</h3>
                <button id="review-modal-close" onclick="app.hideReviewChangesModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Vas a guardar los siguientes cambios en GitHub como un solo commit:</p>
            
            <div class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200 mb-6">
                <ul id="pending-changes-list" class="list-disc list-inside space-y-1 text-sm text-gray-700">
                    <!-- La lista de cambios se genera aquí -->
                </ul>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="app.hideReviewChangesModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="review-modal-confirm-btn" onclick="app._reallySaveAllChanges()" class="px-4 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400">Confirmar y Guardar</button>
            </div>
        </div>
    </div>
    <!-- ... (Modal de Carga de Imagen) ... -->
    <div id="image-upload-loader" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Subiendo Archivo...</h3>
            <p class="text-gray-600">Por favor espera, estamos subiendo tu archivo a GitHub.</p>
        </div>
    </div>


    <!-- INPUTS OCULTOS (Sin cambios) -->
    <input type="file" id="local-file-importer" class="hidden" accept=".json,.csv" onchange="app.handleLocalFileSelected(event)">
    <input type="file" id="image-uploader-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="app.handleImageUpload(event)">
    <input type="file" id="general-file-uploader" class="hidden" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx, .zip, .txt" onchange="app.handleGeneralFileUpload(event)">


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // --- VARIABLES GLOBALES Y ESTADO ---
        let GITHUB_TOKEN = '';
        const GITHUB_API_BASE = 'https://api.github.com';
        let GITHUB_USER = '';

        const appState = {
            loading: false,
            view: 'login', // 'login', 'browser', 'editor'
            isDirty: false, 
            pendingChangesLog: [], 
            repos: [],
            repoFiles: [],
            selectedRepo: '', // e.g., 'user/repo-name'
            selectedFile: '', // e.g., 'path/to/bd.json'
            currentSha: '',
            data: null, 
            dataStructure: 'array', 
            selectedSubject: null, 
            editingItem: null, 
            currentImageFieldTarget: null 
        };

        // --- CONTROLADOR PRINCIPAL DE VISTAS ---
        function renderApp() {
            const views = ['login-view', 'browser-view', 'app-container', 'loading-spinner'];
            const loadingEl = document.getElementById('loading-spinner');
            const logoutBtn = document.getElementById('logout-button');
            const backBtn = document.getElementById('back-to-browser-button');
            const authStatus = document.getElementById('auth-status');
            
            // **** CORRECCIÓN: 'create-file-container' y 'upload-file-button' ya no se manejan aquí ****
            
            const schemaBtn = document.getElementById('schema-manager-button');
            const saveAllBtn = document.getElementById('save-all-button'); 
            const importLocalBtn = document.getElementById('import-local-button'); 
            const imageUploadLoader = document.getElementById('image-upload-loader'); 

            // Resetear vistas
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) {
                    el.classList.add('hidden');
                } else {
                    console.warn(`Elemento con ID "${v}" no encontrado durante renderApp.`);
                }
            });
            
            backBtn.classList.add('hidden');
            schemaBtn.classList.add('hidden');
            saveAllBtn.classList.add('hidden'); 
            importLocalBtn.classList.add('hidden'); 
            imageUploadLoader.classList.add('hidden'); 

            if (appState.loading) {
                loadingEl.classList.remove('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }

            // Mostrar vista actual
            if (appState.view === 'login') {
                document.getElementById('login-view').classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                authStatus.textContent = 'Esperando token de GitHub...';
            } else if (appState.view === 'browser') {
                document.getElementById('browser-view').classList.remove('hidden');
                
                // **** CORRECCIÓN: La lógica de mostrar/ocultar los botones de acción está ahora en handleRepoChange y _reallyGoBackToBrowser ****
                
                logoutBtn.classList.remove('hidden');
                authStatus.textContent = `Conectado como: ${GITHUB_USER}`;
                appState.isDirty = false; 
            } else if (appState.view === 'editor') {
                document.getElementById('app-container').classList.remove('hidden');
                schemaBtn.classList.remove('hidden');
                importLocalBtn.classList.remove('hidden'); 
                logoutBtn.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                saveAllBtn.classList.remove('hidden'); 
                
                saveAllBtn.disabled = !appState.isDirty;
                if (appState.isDirty) {
                    saveAllBtn.textContent = `Guardar Cambios (${appState.pendingChangesLog.length})`;
                } else {
                    saveAllBtn.textContent = 'Guardado';
                }

                authStatus.textContent = `Editando: ${appState.selectedRepo} / ${appState.selectedFile}`;
                renderEditor();
            }
        }

        // --- LÓGICA DE API DE GITHUB (GENÉRICA) ---
        // ... (githubApiFetch sin cambios) ...
        async function githubApiFetch(endpoint, options = {}) {
            if (!GITHUB_TOKEN) {
                console.error("Error: Token de GitHub no encontrado.");
                _reallyLogout(); 
                return;
            }

            // **** CORRECCIÓN: El modal de carga ahora dice "Archivo" en lugar de "Imagen" ****
            if (endpoint.includes('/uploads/')) {
                document.getElementById('image-upload-loader').classList.remove('hidden');
            } else {
                appState.loading = true;
                renderApp();
            }

            const headers = new Headers({
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28',
                ...options.headers,
            });

            try {
                const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, { ...options, headers });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error de GitHub API (${response.status}): ${error.message}`);
                }
                
                if (response.status === 204) { // No Content
                    return null;
                }
                if (response.status === 201) { // Created
                    return await response.json();
                }

                return await response.json();

            } catch (error) {
                console.error("Error en githubApiFetch:", error);
                
                if (error.message.includes("401")) {
                    console.error("Error de Autenticación (401): Token de GitHub inválido, expirado o sin permisos 'repo'.");
                    showConfirmModal({
                        title: "Error de Autenticación",
                        message: "Token de GitHub inválido, expirado o sin permisos 'repo'. Por favor, verifica tu token e inténtalo de nuevo.",
                        confirmText: "Entendido",
                        confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                        onConfirm: _reallyLogout
                    });
                } else {
                    console.error(`Error de API: ${error.message}`);
                    showConfirmModal({
                        title: "Error de API",
                        message: error.message,
                        confirmText: "Entendido",
                        confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                        onConfirm: () => {} 
                    });
                }

            } finally {
                if (endpoint.includes('/uploads/')) {
                    document.getElementById('image-upload-loader').classList.add('hidden');
                } else {
                    appState.loading = false;
                    renderApp();
                }
            }
        }

        // --- 1. LÓGICA DE AUTENTICACIÓN ---
        // ... (handleLogin, logout, _reallyLogout sin cambios) ...
        async function handleLogin() {
            const tokenInput = document.getElementById('token-input');
            if (!tokenInput) {
                console.error("No se encontró 'token-input'.");
                return;
            }
            const token = tokenInput.value;
            
            if (!token) {
                console.warn("Por favor, introduce un token.");
                showConfirmModal({
                    title: "Token Requerido",
                    message: "Por favor, introduce un token de GitHub para continuar.",
                    confirmText: "Entendido",
                    confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                    onConfirm: () => {}
                });
                return;
            }
            GITHUB_TOKEN = token;

            const user = await githubApiFetch('/user');
            if (user) {
                GITHUB_USER = user.login;
                appState.view = 'browser';
                renderApp();
                fetchRepos();
            }
        }

        function logout() {
            if (appState.isDirty) {
                showConfirmModal({
                    title: '¿Cerrar Sesión?',
                    message: 'Tienes cambios locales sin guardar. ¿Estás seguro de que quieres salir y perderlos?',
                    note: 'Los cambios no se guardarán en GitHub.',
                    confirmText: 'Sí, Salir y Descartar',
                    confirmClass: 'bg-red-600 hover:bg-red-700 focus:ring-red-400',
                    onConfirm: _reallyLogout 
                });
            } else {
                _reallyLogout();
            }
        }

        function _reallyLogout() {
            GITHUB_TOKEN = '';
            GITHUB_USER = '';
            Object.assign(appState, {
                loading: false,
                view: 'login',
                isDirty: false,
                pendingChangesLog: [], 
                repos: [],
                repoFiles: [],
                selectedRepo: '',
                selectedFile: '',
                currentSha: '',
                data: null,
                dataStructure: 'array',
                selectedSubject: null,
                editingItem: null,
                currentImageFieldTarget: null
            });
            
            const tokenInput = document.getElementById('token-input');
            if(tokenInput) tokenInput.value = '';
            
            renderApp();
        }

        // ... (goBackToBrowser sin cambios) ...
        function goBackToBrowser() {
            if (appState.isDirty) {
                showConfirmModal({
                    title: '¿Cambiar de Archivo?',
                    message: 'Tienes cambios locales sin guardar. ¿Estás seguro de que quieres salir y perderlos?',
                    note: 'Los cambios no se guardarán en GitHub.',
                    confirmText: 'Sí, Salir y Descartar',
                    confirmClass: 'bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-400',
                    onConfirm: _reallyGoBackToBrowser 
                });
            } else {
                _reallyGoBackToBrowser();
            }
        }
        
        // **** CORRECCIÓN: _reallyGoBackToBrowser ahora oculta el nuevo contenedor de acciones ****
        function _reallyGoBackToBrowser() {
            appState.view = 'browser';
            // Resetear estado del editor
            appState.selectedFile = '';
            appState.currentSha = '';
            appState.data = null;
            appState.selectedSubject = null;
            appState.editingItem = null;
            appState.isDirty = false;
            appState.pendingChangesLog = []; 
            appState.currentImageFieldTarget = null;
            
            try {
                // Ocultar el contenedor de acciones al volver
                document.getElementById('repo-actions-container').classList.add('hidden');
                // Resetear el select de repo
                document.getElementById('repo-select').value = '';
            } catch (e) {
                console.warn("No se pudo resetear la vista de browser:", e);
            }

            renderApp();
        }

        // --- 2. LÓGICA DE NAVEGACIÓN (REPOS Y ARCHIVOS) ---
        
        // ... (fetchRepos sin cambios) ...
        async function fetchRepos() {
            const repoSelect = document.getElementById('repo-select');
            if (!repoSelect) {
                console.error("No se encontró 'repo-select'.");
                return;
            }

            const repos = await githubApiFetch('/user/repos?type=all&sort=updated');
            if (!repos) return;

            appState.repos = repos.map(repo => repo.full_name);
            repoSelect.innerHTML = '<option value="">Selecciona un repositorio...</option>';
            appState.repos.forEach(repoName => {
                const option = new Option(repoName, repoName);
                repoSelect.add(option);
            });
            repoSelect.disabled = false;
        }

        // **** CORRECCIÓN: handleRepoChange ahora carga la lista de archivos automáticamente ****
        async function handleRepoChange(repoFullName) {
            appState.selectedRepo = repoFullName;
            const actionsContainer = document.getElementById('repo-actions-container');
            const fileListContainer = document.getElementById('file-list-container');
            const loadingText = document.getElementById('file-list-loading');
            const createFileBtn = document.getElementById('create-file-button');

            if (!repoFullName) {
                actionsContainer.classList.add('hidden');
                fileListContainer.innerHTML = '';
                loadingText.textContent = 'Selecciona un repositorio para ver los archivos...';
                fileListContainer.appendChild(loadingText);
                return;
            }
            
            // Mostrar el contenedor de acciones
            actionsContainer.classList.remove('hidden');
            createFileBtn.disabled = false; // Habilitar el botón de crear
            loadingText.textContent = 'Cargando archivos...';
            fileListContainer.innerHTML = '';
            fileListContainer.appendChild(loadingText);

            const data = await githubApiFetch(`/repos/${repoFullName}/git/trees/main?recursive=1`);
            if (!data || !data.tree) {
                loadingText.textContent = 'Error al cargar archivos.';
                return;
            }

            appState.repoFiles = data.tree
                .filter(file => file.type === 'blob' && (file.path.endsWith('.json') || file.path.endsWith('.jsonc') || file.path.endsWith('.csv') || file.path.endsWith('.txt')))
                .map(file => file.path);
            
            // Limpiar el contenedor y renderizar botones
            fileListContainer.innerHTML = '';
            
            if (appState.repoFiles.length === 0) {
                 loadingText.textContent = 'No se encontraron archivos .json o .csv en este repositorio.';
                 fileListContainer.appendChild(loadingText);
                 return;
            }
            
            appState.repoFiles.forEach(filePath => {
                const fileBtn = document.createElement('button');
                fileBtn.type = 'button';
                fileBtn.textContent = filePath;
                fileBtn.className = 'file-list-button';
                // Asignar el evento onclick para cargar el archivo
                // **** INICIO DE LA CORRECCIÓN ****
                // Se eliminó la "F" que causaba el error de sintaxis
                fileBtn.onclick = () => app.loadFileContent(filePath);
                // **** FIN DE LA CORRECCIÓN ****
                fileListContainer.appendChild(fileBtn);
            });
        }

        // **** CORRECCIÓN: handleFileChange ya no es necesario ****
        // function handleFileChange(filePath) { ... } // <- ELIMINADO

        // --- 3. LÓGICA DE CARGA Y ANÁLISIS DE DATOS ---
        
        // **** CORRECCIÓN: loadFileContent ahora acepta 'filePath' como argumento ****
        async function loadFileContent(filePath) {
            if (!filePath) {
                console.error("loadFileContent fue llamado sin filePath.");
                return;
            }
            
            appState.selectedFile = filePath; // Establecer el archivo seleccionado

            const fileData = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${filePath}`);
            if (!fileData) return;

            try {
                const decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                
                if (appState.selectedFile.toLowerCase().endsWith('.csv')) {
                    appState.data = csvToJSON(decodedContent);
                } else {
                    appState.data = JSON.parse(decodedContent);
                }

                appState.currentSha = fileData.sha;
                appState.isDirty = false; 
                analyzeDataStructure();
                appState.view = 'editor';
                renderApp();

            } catch (error) {
                console.error("Error al parsear el archivo:", error);
                showConfirmModal({
                    title: "Error de Archivo",
                    message: "Error: El archivo seleccionado no es un JSON, CSV válido o está corrupto.",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            }
        }

        // ... (analyzeDataStructure sin cambios) ...
        function analyzeDataStructure() {
            if (typeof appState.data === 'object' && !Array.isArray(appState.data) && appState.data !== null) {
                const keys = Object.keys(appState.data);
                if (keys.length > 0 && Array.isArray(appState.data[keys[0]])) {
                    appState.dataStructure = 'object-of-arrays';
                    appState.selectedSubject = keys[0]; 
                    return;
                }
            }
            appState.dataStructure = 'array';
            appState.selectedSubject = null;
        }

        // --- 4. LÓGICA DEL EDITOR DINÁMICO ---
        // ... (renderEditor, renderTabs, renderItemsList, renderAddItemForm sin cambios) ...
        function renderEditor() {
            renderTabs();
            renderItemsList();
            renderAddItemForm();
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = '';
            
            if (appState.dataStructure !== 'object-of-arrays') {
                tabsContainer.classList.add('hidden');
                return;
            }

            tabsContainer.classList.remove('hidden');
            const subjects = Object.keys(appState.data);

            subjects.forEach(subject => {
                const isSelected = subject === appState.selectedSubject;
                const tabClasses = isSelected 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'bg-white text-gray-700 hover:bg-gray-100 shadow-sm border border-gray-200';
                
                const tab = document.createElement('button');
                tab.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
                tab.className = `px-4 py-2 font-medium rounded-md ${tabClasses}`;
                tab.onclick = () => {
                    appState.selectedSubject = subject;
                    renderEditor(); 
                };
                tabsContainer.appendChild(tab);
            });
        }

        function renderItemsList() {
            const itemsListContainer = document.getElementById('items-list');
            itemsListContainer.className = "grid grid-cols-1 xl:grid-cols-3 gap-6"; 
            itemsListContainer.innerHTML = '';

            const items = (appState.dataStructure === 'object-of-arrays')
                ? appState.data[appState.selectedSubject]
                : appState.data;

            const title = (appState.dataStructure === 'object-of-arrays')
                ? `Items de "${appState.selectedSubject}"`
                : 'Items del Archivo';
            document.getElementById('items-list-title').textContent = title;

            if (!items || !Array.isArray(items) || items.length === 0) {
                itemsListContainer.innerHTML = '<p class="text-gray-500 lg:col-span-2">No hay items en esta categoría.</p>';
                return;
            }
            
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const filteredItems = items.filter(item => {
                if (!searchTerm) return true;
                return Object.values(item).some(val => 
                    String(val).toLowerCase().includes(searchTerm)
                );
            });

            if (filteredItems.length === 0) {
                itemsListContainer.innerHTML = `<p class="text-gray-500 lg:col-span-2">No se encontraron items que coincidan con "${searchTerm}".</p>`;
            }

            filteredItems.forEach((item) => {
                const originalIndex = items.indexOf(item);
                
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col hover:shadow-lg transition-shadow';
                
                let videoPreviewHtml = '';
                if (item.video_link && typeof item.video_link === 'string') {
                    const embedUrl = getEmbeddableDriveUrl(item.video_link);
                    if (embedUrl) {
                        videoPreviewHtml = `
                            <div 
                                class="video-placeholder aspect-video w-full bg-gray-800 cursor-pointer flex items-center justify-center relative"
                                data-embed-url="${embedUrl + '?autoplay=1'}"
                                onclick="app.loadVideo(this)"
                            >
                                <svg class="w-16 h-16 text-white text-opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                <span class="absolute bottom-2 right-2 text-xs text-white bg-black bg-opacity-50 px-2 py-1 rounded">Cargar video</span>
                            </div>
                        `;
                    }
                }
                
                let cardContentHtml = '<div class="p-4 flex-grow">';
                for (const [key, value] of Object.entries(item)) {
                    if (key.toLowerCase() === 'title') {
                        cardContentHtml += `<h3 class="text-lg font-semibold text-blue-700 mb-1 break-words">${value}</h3>`;
                    } else if (key.toLowerCase() === 'video_link') {
                        cardContentHtml += `<a href="${value}" target="_blank" class="text-sm text-blue-500 hover:underline break-all mt-2 inline-block">Ver Video</a>`;
                    } else if (key.toLowerCase().includes('imagen') || key.toLowerCase().includes('img') || key.toLowerCase().includes('foto') || key.toLowerCase().includes('doc')) { 
                        if (String(value).startsWith('http')) {
                            if (value.match(/\.(jpeg|jpg|gif|png|svg)$/i)) {
                                cardContentHtml += `<img src="${value}" alt="Vista previa" class="w-full h-auto rounded-md my-2 border border-gray-200" onerror="this.style.display='none'">`;
                            } else {
                                cardContentHtml += `<a href="${value}" target="_blank" class="text-sm text-blue-500 hover:underline break-all mt-2 inline-block">Ver Documento: ${key}</a>`;
                            }
                        } else {
                            cardContentHtml += `<p class="text-sm text-gray-600 break-words"><strong>${key}:</strong> ${value}</p>`;
                        }
                    } else if (key.toLowerCase() !== 'description') {
                        cardContentHtml += `<p class="text-sm text-gray-600 break-words"><strong>${key}:</strong> ${value}</p>`;
                    }
                }
                if (item.description) {
                     cardContentHtml += `<p class="text-sm text-gray-700 mt-2 break-words"><strong>Descripción:</strong> ${item.description}</p>`;
                }
                cardContentHtml += '</div>';

                itemEl.innerHTML = `
                    ${videoPreviewHtml}
                    ${cardContentHtml}
                    <div class="p-4 bg-gray-50 border-t border-gray-100 flex gap-3">
                        <button data-index="${originalIndex}" class="edit-btn flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 bg-yellow-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            Editar
                        </button>
                        <button data-index="${originalIndex}" class="delete-btn flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            Eliminar
                        </button>
                    </div>
                `;
                itemsListContainer.appendChild(itemEl);
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = (e) => showEditModal(e.currentTarget.dataset.index);
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = (e) => showDeleteConfirmation(e.currentTarget.dataset.index);
            });
        }

        function renderAddItemForm() {
            const formContainer = document.getElementById('add-item-form-container');
            const items = (appState.dataStructure === 'object-of-arrays')
                ? appState.data[appState.selectedSubject]
                : appState.data;

            const title = (appState.dataStructure === 'object-of-arrays')
                ? `Añadir a "${appState.selectedSubject}"`
                : 'Añadir Nuevo Item';
            
            let schema = null;

            if (items && items.length > 0) {
                schema = items[0]; 
            } else if (appState.dataStructure === 'object-of-arrays') {
                for (const key in appState.data) {
                    if (appState.data[key].length > 0) {
                        schema = appState.data[key][0];
                        break;
                    }
                }
            }

            if (!schema) {
                formContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3><p class="text-gray-500">No se puede generar el formulario porque el archivo o la categoría están vacíos. Intenta usar "Administrar Campos" (⚙️) para añadir el primer campo.</p>`;
                return;
            }

            let formHtml = `
                <h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                <form id="add-form" class="space-y-4">
            `;

            for (const key of Object.keys(schema)) {
                formHtml += generateFormField(key, '', `add-`);
            }
            
            formHtml += `
                            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Añadir Item</button>
                </form>
            `;
            
            formContainer.innerHTML = formHtml;
            document.getElementById('add-form').onsubmit = handleAddItem;
        }


        // --- 5. LÓGICA DE ACCIONES (CRUD) ---

        // ... (generateFormField, handleAddItem, showEditModal, hideEditModal, handleEditItem, showDeleteConfirmation, handleDeleteItem sin cambios) ...
        function generateFormField(key, value, prefix = '') {
            const id = `${prefix}${key}`;
            let field = '';
            const stringValue = (value === null || value === undefined) ? '' : String(value);
            const keyLower = key.toLowerCase();
            
            if (keyLower.includes('imagen') || keyLower.includes('img') || keyLower.includes('foto') || keyLower.includes('icon') || keyLower.includes('doc') || keyLower.includes('archivo')) {
                field = `
                    <div class="flex items-center gap-2">
                        <input type="url" id="${id}" value="${stringValue}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://... o sube un archivo">
                        <button type="button" onclick="app.triggerImageUpload('${id}')" class="p-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400" title="Subir Archivo (Imagen, PDF, Doc...)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            } else if (keyLower.includes('description') || stringValue.length > 80) {
                field = `<textarea id="${id}" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">${stringValue}</textarea>`;
            } else if (keyLower.includes('link') || keyLower.includes('url')) {
                field = `<input type="url" id="${id}" value="${stringValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">`;
            } else {
                field = `<input type="text" id="${id}" value="${stringValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">`;
            }
            
            return `
                <div>
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${key.charAt(0).toUpperCase() + key.slice(1)}</label>
                    ${field}
                </div>
            `;
        }

        function handleAddItem(e) {
            e.preventDefault();
            const items = (appState.dataStructure === 'object-of-arrays')
                ? appState.data[appState.selectedSubject]
                : appState.data;

            let schema = null;
            if (items.length > 0) {
                schema = items[0];
            } else if (appState.dataStructure === 'object-of-arrays') {
                 for(const key in appState.data) {
                    if (appState.data[key].length > 0) {
                        schema = appState.data[key][0];
                        break;
                    }
                 }
            }

            if (!schema) {
                console.error("No se puede añadir item: estructura desconocida.");
                showConfirmModal({
                    title: "Error",
                    message: "No se puede añadir item: estructura desconocida. Intenta añadir un campo primero.",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
                return;
            }

            const newItem = {};
            for (const key of Object.keys(schema)) {
                newItem[key] = document.getElementById(`add-${key}`).value;
            }

            if (appState.dataStructure === 'object-of-arrays') {
                appState.data[appState.selectedSubject].push(newItem);
            } else {
                appState.data.push(newItem);
            }

            appState.isDirty = true;
            const title = newItem.title || newItem.name || `Índice ${appState.data.length - 1}`;
            appState.pendingChangesLog.push(`Item añadido: "${title}"`);
            
            renderApp(); 
            renderEditor(); 
            e.target.reset();
        }

        function showEditModal(index) {
            const items = (appState.dataStructure === 'object-of-arrays')
                ? appState.data[appState.selectedSubject]
                : appState.data;
            
            const item = items[index];
            appState.editingItem = { index: parseInt(index) };
            
            let formHtml = '';
            for (const [key, value] of Object.entries(item)) {
                formHtml += generateFormField(key, value, 'edit-');
            }
            formHtml += `
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="app.hideEditModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Guardar Cambios</button>
                </div>
            `;

            document.getElementById('edit-form').innerHTML = formHtml;
            document.getElementById('edit-form').onsubmit = handleEditItem;
            document.getElementById('edit-modal-title').textContent = `Editar Item (Índice ${index})`;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function hideEditModal() {
            appState.editingItem = null;
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function handleEditItem(e) {
            e.preventDefault();
            if (!appState.editingItem) return;

            const { index } = appState.editingItem;
            
            const items = (appState.dataStructure === 'object-of-arrays')
                ? appState.data[appState.selectedSubject]
                : appState.data;
            
            const oldItem = items[index];
            const updatedItem = {};
            for (const key of Object.keys(oldItem)) {
                updatedItem[key] = document.getElementById(`edit-${key}`).value;
            }

            if (appState.dataStructure === 'object-of-arrays') {
                appState.data[appState.selectedSubject][index] = updatedItem;
            } else {
                appState.data[index] = updatedItem;
            }

            appState.isDirty = true;
            const title = updatedItem.title || updatedItem.name || `Índice ${index}`;
            appState.pendingChangesLog.push(`Item editado: "${title}"`);
            
            renderApp(); 
            renderEditor(); 
            hideEditModal();
        }

        function showDeleteConfirmation(index) {
            appState.editingItem = { index: parseInt(index) };
            showConfirmModal({
                title: 'Confirmar Eliminación',
                message: '¿Estás seguro de que quieres eliminar este item?',
                note: 'Esto solo se borrará localmente. Presiona "Guardar Cambios" para hacerlo permanente.',
                confirmText: 'Sí, Eliminar',
                confirmClass: 'bg-red-600 hover:bg-red-700 focus:ring-red-400',
                onConfirm: handleDeleteItem
            });
        }
        
        function handleDeleteItem() {
            if (!appState.editingItem) return;
            const { index } = appState.editingItem;

            appState.isDirty = true;
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const deletedItem = items[index]; 
            const title = deletedItem.title || deletedItem.name || `Índice ${index}`;
            appState.pendingChangesLog.push(`Item eliminado: "${title}"`);

            if (appState.dataStructure === 'object-of-arrays') {
                appState.data[appState.selectedSubject].splice(index, 1);
            } else {
                appState.data.splice(index, 1);
            }
            
            appState.editingItem = null; 
            renderApp(); 
            renderEditor(); 
        }

        // --- 6. LÓGICA DE GUARDADO EN GITHUB ---
        // ... (saveAllChanges, showReviewChangesModal, hideReviewChangesModal, _reallySaveAllChanges, saveChangesToGitHub sin cambios) ...
        function saveAllChanges() {
            if (!appState.isDirty || appState.pendingChangesLog.length === 0) {
                return;
            }
            showReviewChangesModal();
        }

        function showReviewChangesModal() {
            const listEl = document.getElementById('pending-changes-list');
            listEl.innerHTML = ''; 
            
            appState.pendingChangesLog.forEach(logEntry => {
                const li = document.createElement('li');
                li.textContent = logEntry;
                listEl.appendChild(li);
            });
            
            document.getElementById('review-changes-modal').classList.remove('hidden');
        }

        function hideReviewChangesModal() {
            document.getElementById('review-changes-modal').classList.add('hidden');
        }
        
        async function _reallySaveAllChanges() {
            const success = await saveChangesToGitHub(appState.data);
            
            if (success) {
                appState.isDirty = false;
                appState.pendingChangesLog = []; 
                hideReviewChangesModal(); 
                renderApp(); 
            } else {
                console.error("No se pudieron guardar los cambios.");
            }
        }
        
        async function saveChangesToGitHub(newData) {
            const commitMessage = `Actualizado ${appState.selectedFile} desde la plataforma de admin`;
            let newContent = '';

            if (appState.selectedFile.toLowerCase().endsWith('.csv')) {
                newContent = jsonToCSV(newData);
            } else {
                newContent = JSON.stringify(newData, null, 2); 
            }

            const newContentBase64 = btoa(unescape(encodeURIComponent(newContent)));

            const endpoint = `/repos/${appState.selectedRepo}/contents/${appState.selectedFile}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({
                    message: commitMessage,
                    content: newContentBase64,
                    sha: appState.currentSha 
                })
            };

            const result = await githubApiFetch(endpoint, options);
            
            if (result && result.content) {
                appState.currentSha = result.content.sha;
                appState.data = newData; 
                renderEditor();
                showConfirmModal({
                    title: "Éxito",
                    message: "¡Cambios guardados en GitHub con éxito!",
                    confirmText: "Entendido",
                    confirmClass: "bg-green-600 hover:bg-green-700 focus:ring-green-400",
                    onConfirm: () => {}
                });
                return true; 
            } else if (result === null) {
                console.warn("Guardado exitoso (204), recargando SHA.");
                const fileData = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${appState.selectedFile}`);
                if (fileData) {
                    appState.currentSha = fileData.sha;
                    appState.data = newData;
                    renderEditor();
                    showConfirmModal({
                        title: "Éxito",
                        message: "¡Cambios guardados en GitHub con éxito!",
                        confirmText: "Entendido",
                        confirmClass: "bg-green-600 hover:bg-green-700 focus:ring-green-400",
                        onConfirm: () => {}
                    });
                    return true; 
                }
            }
            
            return false; 
        }

        // --- Lógica de "Crear Nuevo Archivo" (Sin cambios) ---
        async function createNewFile() {
            const fileNameInput = document.getElementById('new-file-name');
            if (!fileNameInput) {
                console.error("No se encontró 'new-file-name'.");
                return;
            }
            const fileName = fileNameInput.value;
            
            if (!fileName || !appState.selectedRepo) {
                showConfirmModal({
                    title: "Error",
                    message: "Por favor, introduce un nombre de archivo válido (ej: datos/nuevo.json o .csv).",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
                return;
            }

            let initialContent = '';
            if (fileName.toLowerCase().endsWith('.json')) {
                initialContent = '[]'; 
            } else if (fileName.toLowerCase().endsWith('.csv')) {
                initialContent = 'id,nombre,descripcion'; 
            } else {
                showConfirmModal({
                    title: "Error",
                    message: "El nombre de archivo debe terminar en .json o .csv",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
                return;
            }

            const commitMessage = `Creado ${fileName} desde la plataforma de admin`;
            const newContentBase64 = btoa(unescape(encodeURIComponent(initialContent)));

            const endpoint = `/repos/${appState.selectedRepo}/contents/${fileName}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({
                    message: commitMessage,
                    content: newContentBase64
                })
            };

            const result = await githubApiFetch(endpoint, options);
            
            if (result && result.content) {
                showConfirmModal({
                    title: "Éxito",
                    message: `¡Archivo "${fileName}" creado con éxito!`,
                    confirmText: "Entendido",
                    confirmClass: "bg-green-600 hover:bg-green-700 focus:ring-green-400",
                    onConfirm: () => {}
                });
                fileNameInput.value = '';
                handleRepoChange(appState.selectedRepo); // Recargar la lista de archivos
            } else {
                showConfirmModal({
                    title: "Error",
                    message: "Error al crear el archivo. ¿Quizás ya existe?",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            }
        }


        // --- Lógica de "Administrar Campos" (Sin cambios) ---
        function showSchemaModal() {
            document.getElementById('schema-modal').classList.remove('hidden');
            document.getElementById('schema-form').onsubmit = handleAddField;
        }

        function hideSchemaModal() {
            document.getElementById('schema-modal').classList.add('hidden');
            document.getElementById('schema-form').reset();
        }

        function handleAddField(e) {
            e.preventDefault();
            const newField = document.getElementById('new-field-name').value;
            const defaultValue = document.getElementById('new-field-default-value').value;

            if (!newField) {
                showConfirmModal({
                    title: "Error",
                    message: "Por favor, introduce un nombre para el nuevo campo.",
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
                return;
            }

            const newData = JSON.parse(JSON.stringify(appState.data));

            if (appState.dataStructure === 'object-of-arrays') {
                Object.keys(newData).forEach(subject => {
                    newData[subject].forEach(item => {
                        if (item[newField] === undefined) {
                            item[newField] = defaultValue;
                        }
                    });
                });
            } else { // 'array'
                newData.forEach(item => {
                    if (item[newField] === undefined) {
                        item[newField] = defaultValue;
                    }
                });
            }

            appState.data = newData;
            appState.isDirty = true;
            appState.pendingChangesLog.push(`Campo añadido a todos: "${newField}"`);
            
            hideSchemaModal();
            renderApp(); 
            renderEditor(); 
            
            showConfirmModal({
                title: "Éxito Local",
                message: `¡Campo "${newField}" añadido localmente! Presiona "Guardar Cambios" para aplicar en GitHub.`,
                confirmText: "Entendido",
                confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                onConfirm: () => {}
            });
        }


        // --- LÓGICA DE UTILIDAD (Sin cambios) ---

        // ... (triggerImportModal, handleLocalFileSelected, getEmbeddableDriveUrl, loadVideo) ...
        
        function triggerImportModal() {
            showConfirmModal({
                title: 'Importar Archivo Local (Reemplazo)',
                message: 'Esto reemplazará todos tus cambios locales actuales con el contenido de un archivo .json o .csv de tu computadora. ¿Estás seguro?',
                note: 'Los cambios no se guardarán en GitHub hasta que presiones "Guardar Cambios".',
                confirmText: 'Sí, Importar y Reemplazar',
                confirmClass: 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-400',
                onConfirm: () => {
                    document.getElementById('local-file-importer').click();
                }
            });
        }

        async function handleLocalFileSelected(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            let parsedData;

            try {
                const content = await file.text();
                
                if (fileName.toLowerCase().endsWith('.json')) {
                    parsedData = JSON.parse(content);
                } else if (fileName.toLowerCase().endsWith('.csv')) {
                    parsedData = csvToJSON(content); 
                } else {
                    showConfirmModal({
                        title: "Error de Archivo",
                        message: "Error: Tipo de archivo no compatible. Por favor, selecciona un .json o .csv.",
                        confirmText: "Entendido",
                        confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                        onConfirm: () => {}
                    });
                    return;
                }

                const isOriginalArray = (appState.dataStructure === 'array');
                const isNewDataArray = Array.isArray(parsedData);

                if (isOriginalArray && !isNewDataArray) {
                     showConfirmModal({
                        title: "Error de Estructura",
                        message: "Error: El archivo original es un array simple (ej: [ ]), pero el archivo que importaste es un objeto (ej: { \"pestana\": [] }). No se pueden mezclar.",
                        confirmText: "Entendido",
                        confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                        onConfirm: () => {}
                    });
                    return;
                }
                if (!isOriginalArray && isNewDataArray) {
                    showConfirmModal({
                        title: "Error de Estructura",
                        message: "Error: El archivo original es un objeto de pestañas (ej: { \"pestana\": [] }), pero el archivo que importaste es un array simple (ej: [ ]). No se pueden mezclar.",
                        confirmText: "Entendido",
                        confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                        onConfirm: () => {}
                    });
                    return;
                }
                
                appState.data = parsedData; 
                appState.isDirty = true;
                appState.pendingChangesLog = [`Importado contenido completo desde el archivo local: "${fileName}"`];

                analyzeDataStructure();
                
                renderApp();
                renderEditor();
                
                showConfirmModal({
                    title: "Éxito de Importación",
                    message: `¡Éxito! Contenido de "${fileName}" importado. Revisa los cambios y presiona "Guardar Cambios".`,
                    confirmText: "Entendido",
                    confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                    onConfirm: () => {}
                });

            } catch (error) {
                console.error("Error al importar archivo local:", error);
                showConfirmModal({
                    title: "Error al Importar",
                    message: `Error al leer o parsear el archivo: ${error.message}`,
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            } finally {
                event.target.value = null;
            }
        }
        
        function getEmbeddableDriveUrl(url) {
            if (!url || !url.includes('drive.google.com')) return '';
            const match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://drive.google.com/file/d/${match[1]}/preview`;
            }
            return '';
        }

        function loadVideo(element) {
            const url = element.dataset.embedUrl;
            if (url) {
                element.innerHTML = `
                    <iframe src="${url}" 
                        class="w-full h-full border-0" 
                        allowfullscreen 
                        allow="autoplay; encrypted-media">
                    </iframe>
                `;
                element.onclick = null;
                element.classList.remove('cursor-pointer', 'flex', 'items-center', 'justify-center');
            }
        }

        // ... (triggerImageUpload, handleImageUpload sin cambios: esta es la subida *dentro* del formulario) ...
        function triggerImageUpload(targetInputId) {
            appState.currentImageFieldTarget = targetInputId;
            document.getElementById('image-uploader-input').click();
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !appState.currentImageFieldTarget) return;

            const fileName = `${Date.now()}-${file.name}`;
            const filePath = `uploads/${fileName}`;

            try {
                const base64Content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });

                const endpoint = `/repos/${appState.selectedRepo}/contents/${filePath}`;
                const options = {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Subido ${fileName} desde la plataforma`,
                        content: base64Content,
                    })
                };

                const result = await githubApiFetch(endpoint, options);
                
                if (result && result.content && result.content.download_url) {
                    const downloadUrl = result.content.download_url;
                    
                    document.getElementById(appState.currentImageFieldTarget).value = downloadUrl;
                    
                    appState.isDirty = true;
                    appState.pendingChangesLog.push(`Archivo subido: "${fileName}"`);
                    
                    renderApp(); 
                    
                    showConfirmModal({
                        title: "Archivo Subido",
                        message: `¡Archivo "${fileName}" subido con éxito! La URL ha sido añadida. No olvides guardar los cambios.`,
                        confirmText: "Entendido",
                        confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                        onConfirm: () => {}
                    });
                    
                } else {
                    throw new Error("La respuesta de GitHub no contenía la URL de descarga.");
                }

            } catch (error) {
                console.error("Error al subir el archivo:", error);
                showConfirmModal({
                    title: "Error al Subir Archivo",
                    message: `Error al subir el archivo: ${error.message}`,
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            } finally {
                event.target.value = null;
                appState.currentImageFieldTarget = null;
            }
        }

        // ... (triggerGeneralFileUpload, handleGeneralFileUpload sin cambios: esta es la subida *general*) ...
        function triggerGeneralFileUpload() {
            document.getElementById('general-file-uploader').click();
        }

        async function handleGeneralFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = `${Date.now()}-${file.name}`;
            const filePath = `uploads/${fileName}`; 

            try {
                const base64Content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });

                const endpoint = `/repos/${appState.selectedRepo}/contents/${filePath}`;
                const options = {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Subido ${fileName} desde la plataforma (general)`,
                        content: base64Content,
                    })
                };

                const result = await githubApiFetch(endpoint, options);
                
                if (result && result.content && result.content.download_url) {
                    const downloadUrl = result.content.download_url;
                    
                    showConfirmModal({
                        title: "Archivo Subido con Éxito",
                        message: `Tu archivo "${fileName}" se subió. Puedes copiar la URL:\n\n${downloadUrl}`,
                        note: "Pega esta URL en cualquier campo de texto.",
                        confirmText: "¡Entendido!",
                        confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                        onConfirm: () => {}
                    });
                    
                } else {
                    throw new Error("La respuesta de GitHub no contenía la URL de descarga.");
                }

            } catch (error) {
                console.error("Error al subir el archivo general:", error);
                showConfirmModal({
                    title: "Error al Subir Archivo",
                    message: `Error al subir el archivo: ${error.message}`,
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            } finally {
                event.target.value = null;
            }
        }

        // ... (csvToJSON, jsonToCSV sin cambios) ...
        function csvToJSON(csvString) {
            const result = Papa.parse(csvString, {
                header: true, 
                skipEmptyLines: true,
                dynamicTyping: true 
            });
            if (result.errors.length > 0) {
                console.error("Errores de PapaParse (CSV a JSON):", result.errors);
                showConfirmModal({
                    title: "Error de CSV",
                    message: `Error al leer el CSV: ${result.errors[0].message}`,
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
            }
            return result.data;
        }

        function jsonToCSV(jsonArray) {
            if (!jsonArray || jsonArray.length === 0) return '';
            
            try {
                return Papa.unparse(jsonArray);
            } catch (error) {
                console.error("Error de PapaParse (JSON a CSV):", error);
                showConfirmModal({
                    title: "Error de CSV",
                    message: `Error al convertir a CSV: ${error.message}`,
                    confirmText: "Entendido",
                    confirmClass: "bg-red-600 hover:bg-red-700 focus:ring-red-400",
                    onConfirm: () => {}
                });
                return '';
            }
        }

        // ... (showConfirmModal, hideConfirmModal, listener 'beforeunload' sin cambios) ...
        function showConfirmModal({ title, message, note, confirmText, confirmClass, onConfirm }) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            
            const noteEl = document.getElementById('confirm-modal-note');
            if (note) {
                noteEl.textContent = note;
                noteEl.classList.remove('hidden');
            } else {
                noteEl.classList.add('hidden');
            }

            const acceptBtn = document.getElementById('confirm-modal-accept-btn');
            acceptBtn.textContent = confirmText;
            
            acceptBtn.className = 'px-4 py-2 text-white rounded-md shadow-sm focus:outline-none focus:ring-2';
            acceptBtn.classList.add(...confirmClass.split(' '));

            const newAcceptBtn = acceptBtn.cloneNode(true);
            newAcceptBtn.onclick = () => {
                hideConfirmModal(); 
                onConfirm();       
            };
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        window.addEventListener('beforeunload', (event) => {
            if (appState.isDirty) {
                event.preventDefault();
                event.returnValue = '';
            }
        });

        // --- INICIO DE LA APP ---
        window.app = {
            handleLogin,
            logout,
            goBackToBrowser,
            handleRepoChange,
            // **** CORRECCIÓN: handleFileChange eliminado ****
            loadFileContent, // <-- Ahora se pasa el 'filePath'
            showEditModal,
            hideEditModal,
            handleEditItem,
            showDeleteConfirmation,
            hideConfirmModal, 
            handleDeleteItem,
            handleAddItem,
            loadVideo,
            renderItemsList, 
            createNewFile,
            showSchemaModal,
            hideSchemaModal,
            handleAddField,
            saveAllChanges, 
            _reallySaveAllChanges, 
            showReviewChangesModal, 
            hideReviewChangesModal, 
            triggerImportModal, 
            handleLocalFileSelected, 
            triggerImageUpload, 
            handleImageUpload, 
            triggerGeneralFileUpload, 
            handleGeneralFileUpload   
        };

        // Render inicial
        renderApp();
    </script>

</body>
</html>

