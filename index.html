<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />

    <style>
        .video-placeholder svg { transition: transform 0.2s ease-in-out; }
        .video-placeholder:hover svg { transform: scale(1.1); }

        .file-list-item {
            display: flex; align-items: center; justify-content: space-between; width: 100%;
            text-align: left; padding: 0.75rem 1rem; background-color: #ffffff;
            color: #374151; border: 1px solid #e5e7eb; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease-in-out;
            word-break: break-all;
        }
        .file-list-item:hover {
            border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); color: #1d4ed8;
        }
        .file-actions {
            display: flex;
            gap: 0.5rem; 
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .file-list-item:hover .file-actions { visibility: visible; opacity: 1; }
        .file-actions button {
            padding: 0.25rem; border-radius: 0.375rem;
        }
        .file-actions button:hover { background-color: #f3f4f6; /* gray-100 */ }
        .file-actions .delete-btn:hover { background-color: #fee2e2; color: #dc2626; } 
        .file-actions .duplicate-btn:hover { background-color: #dbeafe; color: #2563eb; } 

        .file-list-name {
            display: flex; align-items: center; gap: 0.5rem;
            flex-grow: 1; cursor: pointer;
            overflow: hidden; 
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        #preview-container {
             background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem;
             padding: 1rem; overflow: auto; max-height: 80vh; position: relative; 
        }
        #preview-container img { max-width: 100%; height: auto; display: block; margin: auto; }
        #preview-container iframe, #preview-container embed { width: 100%; height: 70vh; border: none; }
        
        code[class*="language-"], pre[class*="language-"] {
            color: #f8f8f2; background: none; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            text-align: left; white-space: pre; word-spacing: normal; word-break: normal; word-wrap: normal;
            line-height: 1.5; tab-size: 4; hyphens: none; border-radius: 0.375rem;
        }
        pre[class*="language-"] { padding: 1em; margin: .5em 0; overflow: auto; background: #272822; }

        #breadcrumb-container a { color: #3b82f6; text-decoration: none; }
        #breadcrumb-container a:hover { text-decoration: underline; }
        #breadcrumb-container span { color: #6b7280; margin: 0 0.25rem; }
        #breadcrumb-container span:last-child { color: #111827; font-weight: 500; }
        #breadcrumb-container span:last-child a { color: inherit; pointer-events: none; }

        #code-editor-textarea {
            width: 100%; height: 60vh; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            background-color: #272822; color: #f8f8f2; border: 1px solid #444;
            border-radius: 0.375rem; padding: 1rem; line-height: 1.5;
        }

    </style>
</head>
<body class="bg-gray-50">

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="max-w-7xl mx-auto px-4 md:px-8">

        <!-- Encabezado Fijo -->
        <header class="sticky top-0 z-40 bg-gray-50/90 backdrop-blur-md pt-6 pb-4 mb-6 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-blue-700">Explorador de Repositorio (GitHub)</h1>
                <p id="auth-status" class="text-sm text-gray-600">Esperando token de GitHub...</p>
            </div>
            <div class="flex items-center">
                <button id="back-to-browser-button" onclick="app.goBackToBrowser()" class="hidden px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 mr-2">
                    Volver al Explorador
                </button>
                <button id="save-all-button" onclick="app.saveAllChanges()" class="hidden px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 mr-2" disabled>
                    Guardado
                </button>
                <button id="logout-button" onclick="app.logout()" class="hidden px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        
        <!-- 1. VISTA DE LOGIN -->
        <div id="login-view" class="hidden max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200 mt-10">
             <h2 class="text-2xl font-semibold text-gray-800 mb-4">Iniciar Sesión</h2>
             <p class="text-gray-600 mb-6">Por favor, introduce tu <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 hover:underline">Token de Acceso Personal (PAT)</a> de GitHub. Asegúrate de que tenga permisos de `repo`.</p>
             <div class="space-y-4">
                 <div>
                     <label for="token-input" class="block text-sm font-medium text-gray-700 mb-1">Token de GitHub</label>
                     <input type="password" id="token-input" placeholder="ghp_..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                 <button onclick="app.handleLogin()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                     Conectar
                 </button>
             </div>
        </div>
        
        <!-- 2. VISTA DE NAVEGADOR DE ARCHIVOS -->
        <div id="browser-view" class="hidden max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200 mt-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Explorador de Repositorio</h2>
            <div>
                <label for="repo-select" class="block text-sm font-medium text-gray-700 mb-1">Repositorio Seleccionado</label>
                <select id="repo-select" onchange="app.handleRepoChange(this.value)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <option value="">Cargando repositorios...</option>
                </select>
            </div>
            
            <div id="repo-actions-container" class="hidden mt-6 space-y-6">
            
                <div id="breadcrumb-container" class="text-sm font-medium text-gray-500 bg-gray-50 p-3 rounded-md border"></div>

                <div>
                    <h3 id="upload-file-label" class="text-lg font-medium text-gray-700 mb-2">Subir un Archivo</h3>
                    <p class="text-sm text-gray-500 mb-3">Sube una imagen, PDF o documento a la carpeta actual.</p>
                    <button id="upload-file-button" onclick="app.triggerGeneralFileUpload()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                        Subir Archivo
                    </button>
                </div>

                <div id="create-file-container" class="pt-6 border-t border-gray-200">
                    <h3 id="create-file-label" class="text-lg font-medium text-gray-700 mb-3">Crear nuevo archivo</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-file-name" placeholder="ej: datos.json, pagina.html, notas.txt" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="create-file-button" onclick="app.createNewFile()" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400" disabled>
                            Crear
                        </button>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">Puedes crear `.json`, `.csv`, `.txt`, `.md`, `.html`, etc.</p>
                </div>

                <div id="file-list-section" class="pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Contenido de la Carpeta</h3>
                    <div id="file-list-container" class="space-y-2 hidden"></div>
                    <p id="file-list-loading" class="text-gray-500">Selecciona un repositorio para ver los archivos...</p>
                </div>

            </div>
        </div>
        
        <!-- 3. INDICADOR DE CARGA GLOBAL -->
        <div id="loading-spinner" class="hidden text-center p-10">
            <p class="text-lg font-medium text-blue-600">Cargando...</p>
        </div>

        <!-- 4. VISTA DE EDITOR / PREVISUALIZADOR -->
        <main id="app-container" class="hidden"> 
            <div id="json-csv-editor" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="tabs-container" class="lg:col-span-3 flex flex-wrap gap-2 mb-2"></div>
                <section class="lg:col-span-2">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
                        <h2 id="items-list-title" class="text-2xl font-semibold text-gray-800">Items</h2>
                        <div class="flex items-center gap-2">
                            <div class="relative flex-grow">
                                <input type="search" id="search-bar" oninput="app.renderItemsList()" placeholder="Buscar items..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                            </div>
                            <button id="import-local-button" onclick="app.triggerImportModal()" class="p-2 bg-white text-blue-600 rounded-md shadow-sm border border-gray-300 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Importar desde local (Reemplaza datos JSON/CSV)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="schema-manager-button" onclick="app.showSchemaModal()" class="p-2 bg-white text-gray-600 rounded-md shadow-sm border border-gray-300 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Administrar Campos">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM17 8a1 1 0 10-2 0v.268a2 2 0 000 3.464V16a1 1 0 102 0v-4.268a2 2 0 000-3.464V8z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="items-list"></div>
                </section>
                <section id="add-item-form-container" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 h-fit lg:sticky lg:top-28"></section>
            </div>
            <div id="preview-container" class="hidden"></div>
        </main>
    </div>

    <!-- MODALES -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="edit-modal-title" class="text-xl font-semibold text-gray-800">Editar Item</h3>
                <button id="edit-modal-close" onclick="app.hideEditModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-form" class="space-y-4"></form>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="confirm-modal-title" class="text-xl font-semibold text-gray-800">Confirmar</h3>
                <button id="confirm-modal-close" onclick="app.hideConfirmModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p id="confirm-modal-message" class="text-gray-600 mb-4 whitespace-pre-wrap">¿Estás seguro?</p>
            <p id="confirm-modal-note" class="text-sm text-red-600 mb-6 hidden">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-modal-cancel" onclick="app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="confirm-modal-accept-btn" class="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">Sí, Confirmar</button>
            </div>
        </div>
    </div>
    <div id="schema-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Administrar Campos</h3>
                <button id="schema-modal-close" onclick="app.hideSchemaModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Añade un nuevo campo a **todos** los items de este archivo. Si el campo ya existe en un item, no será modificado.</p>
            <form id="schema-form" class="space-y-4">
                <div>
                    <label for="new-field-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Nuevo Campo</label>
                    <input type="text" id="new-field-name" placeholder="ej: autor" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="new-field-default-value" class="block text-sm font-medium text-gray-700 mb-1">Valor por Defecto</label>
                    <input type="text" id="new-field-default-value" placeholder="ej: N/A" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="app.hideSchemaModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Añadir Campo a Todos</button>
                </div>
            </form>
        </div>
    </div>
    <div id="review-changes-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Revisar Cambios Pendientes</h3>
                <button id="review-modal-close" onclick="app.hideReviewChangesModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Vas a guardar los siguientes cambios en GitHub como un solo commit:</p>
            <div class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200 mb-6">
                <ul id="pending-changes-list" class="list-disc list-inside space-y-1 text-sm text-gray-700"></ul>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="app.hideReviewChangesModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="review-modal-confirm-btn" onclick="app._reallySaveAllChanges()" class="px-4 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400">Confirmar y Guardar</button>
            </div>
        </div>
    </div>
    <div id="image-upload-loader" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Subiendo Archivo...</h3>
            <p class="text-gray-600">Por favor espera, estamos subiendo tu archivo a GitHub.</p>
        </div>
    </div>
    <div id="code-edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="code-edit-modal-title" class="text-xl font-semibold text-gray-800">Editar Archivo</h3>
                <button id="code-edit-modal-close" onclick="app.hideCodeEditor()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <textarea id="code-editor-textarea" class="flex-grow"></textarea>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="app.hideCodeEditor()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="code-edit-save-btn" onclick="app.handleSaveCodeFile()" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Guardar Cambios</button>
            </div>
        </div>
    </div>
    <div id="input-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="input-modal-title" class="text-xl font-semibold text-gray-800">Input Requerido</h3>
                <button id="input-modal-close" onclick="app.hideInputModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <p id="input-modal-message" class="text-gray-600 mb-4">Por favor, introduce un valor:</p>
            <input type="text" id="input-modal-field" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6">
            <div class="flex justify-end gap-3">
                <button type="button" onclick="app.hideInputModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button type="button" id="input-modal-accept-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Aceptar</button>
            </div>
        </div>
    </div>


    <!-- INPUTS OCULTOS -->
    <input type="file" id="local-file-importer" class="hidden" accept=".json,.csv" onchange="app.handleLocalFileSelected(event)">
    <input type="file" id="image-uploader-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="app.handleImageUpload(event)">
    <input type="file" id="general-file-uploader" class="hidden" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx, .zip, .txt, .md, .html, .css, .js" onchange="app.handleGeneralFileUpload(event)">


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // --- VARIABLES GLOBALES Y ESTADO ---
        let GITHUB_TOKEN = '';
        const GITHUB_API_BASE = 'https://api.github.com';
        let GITHUB_USER = '';
        const GITHUB_TOKEN_KEY = 'github_admin_pat';
        const GITHUB_USER_KEY = 'github_admin_user';
        const GITHUB_REPO_KEY = 'github_admin_repo';

        const appState = {
            loading: false, view: 'login', isDirty: false, pendingChangesLog: [], 
            repos: [], selectedRepo: '', currentPath: '', selectedFile: '',
            currentSha: '', data: null, dataType: 'raw', downloadUrl: null, 
            dataStructure: 'array', selectedSubject: null, editingItem: null,
            currentImageFieldTarget: null 
        };

        // --- CONTROLADOR PRINCIPAL DE VISTAS ---
        function renderApp() {
            console.log(`[Render] Cambiando a vista: ${appState.view}`);
            const views = ['login-view', 'browser-view', 'app-container', 'loading-spinner'];
            const editorElements = ['json-csv-editor', 'schema-manager-button', 'import-local-button', 'save-all-button'];
            const previewElements = ['preview-container'];

            const loadingEl = document.getElementById('loading-spinner');
            const logoutBtn = document.getElementById('logout-button');
            const backBtn = document.getElementById('back-to-browser-button');
            const authStatus = document.getElementById('auth-status');
            const imageUploadLoader = document.getElementById('image-upload-loader'); 
            const saveAllBtn = document.getElementById('save-all-button'); 

            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.add('hidden');
                else console.warn(`[Render] Elemento ${v} no encontrado.`);
            });
            editorElements.forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.classList.add('hidden');
            });
             previewElements.forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.classList.add('hidden');
            });
            backBtn.classList.add('hidden'); 
            imageUploadLoader.classList.add('hidden'); 

            if (appState.loading) loadingEl.classList.remove('hidden');
            else loadingEl.classList.add('hidden');

            if (appState.view === 'login') {
                const loginView = document.getElementById('login-view');
                if (loginView) {
                    loginView.classList.remove('hidden');
                } else {
                    console.error('[Render] !! FATAL: Elemento login-view no encontrado !!'); 
                }
                logoutBtn.classList.add('hidden');
                authStatus.textContent = 'Esperando token de GitHub...';
            } else if (appState.view === 'browser') {
                document.getElementById('browser-view').classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                authStatus.textContent = `Conectado como: ${GITHUB_USER}`;
                appState.isDirty = false; 
            } else if (appState.view === 'editor') {
                document.getElementById('app-container').classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                authStatus.textContent = `Viendo: ${appState.selectedRepo} / ${appState.selectedFile}`;

                if (appState.dataType === 'json-csv') {
                    console.log('[Render] Mostrando editor JSON/CSV');
                    document.getElementById('json-csv-editor').classList.remove('hidden');
                    document.getElementById('schema-manager-button').classList.remove('hidden');
                    document.getElementById('import-local-button').classList.remove('hidden');
                    document.getElementById('save-all-button').classList.remove('hidden');

                    saveAllBtn.disabled = !appState.isDirty;
                    if (appState.isDirty) {
                        saveAllBtn.textContent = `Guardar Cambios (${appState.pendingChangesLog.length})`;
                    } else {
                        saveAllBtn.textContent = 'Guardado';
                    }
                    renderEditor(); 
                } else {
                    console.log('[Render] Mostrando previsualizador');
                    document.getElementById('preview-container').classList.remove('hidden');
                }
            }
        }

        // --- LÓGICA DE API DE GITHUB (GENÉRICA) ---
        async function githubApiFetch(endpoint, options = {}) {
             if (!GITHUB_TOKEN) {
                console.error("[API] Error: Token de GitHub no encontrado.");
                _reallyLogout(); 
                return;
            }
            
            console.log(`[API] Petición: ${options.method || 'GET'} ${endpoint}`);

            if (endpoint.includes('/uploads/')) {
                document.getElementById('image-upload-loader').classList.remove('hidden');
            } else if (!endpoint.includes('/user') && !endpoint.includes('/repos') && !endpoint.includes('/contents')) {
                 appState.loading = true;
                 renderApp();
            }

            const headers = new Headers({
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28',
                ...options.headers,
            });

            const fetchOptions = { ...options, headers };
            if (!options.method || options.method.toUpperCase() === 'GET') {
                fetchOptions.cache = 'no-cache';
            }

            try {
                const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, fetchOptions);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error de GitHub API (${response.status}): ${error.message}`);
                }
                
                if (response.status === 204) { return null; } 
                if (response.status === 200 && options.method === 'DELETE') { return await response.json(); } 
                if (response.status === 201) { return await response.json(); } 

                return await response.json();

            } catch (error) {
                console.error("[API] Error en githubApiFetch:", error);
                
                if (error.message.includes("401")) {
                    console.error("[Auth] Error de Autenticación (401)");
                    showConfirmModal({ title: "Error de Autenticación", message: "Token de GitHub inválido, expirado o sin permisos 'repo'.", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: _reallyLogout });
                } else if (error.message.includes("404")) { 
                    console.warn(`[API] Recurso no encontrado (404): ${endpoint}`);
                     return []; 
                } else {
                    console.error(`[API] Error: ${error.message}`);
                    showConfirmModal({ title: "Error de API", message: error.message, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                }
                 return undefined; 

            } finally {
                if (endpoint.includes('/uploads/')) {
                    document.getElementById('image-upload-loader').classList.add('hidden');
                } else if (appState.loading) { 
                    appState.loading = false;
                    renderApp();
                }
            }
        }

        // --- 1. LÓGICA DE AUTENTICACIÓN ---
        async function initializeApp() {
            console.log('[App] Inicializando aplicación...');
            const token = localStorage.getItem(GITHUB_TOKEN_KEY);
            const user = localStorage.getItem(GITHUB_USER_KEY);

            if (token && user) {
                console.log('[App] Sesión guardada encontrada. Verificando token...');
                GITHUB_TOKEN = token;
                GITHUB_USER = user;

                const userData = await githubApiFetch('/user'); 
                
                if (userData) {
                    console.log(`[App] Token verificado. Sesión restaurada para ${GITHUB_USER}.`);
                    appState.view = 'browser';
                    renderApp(); 
                    await fetchRepos(); 

                    const savedRepo = localStorage.getItem(GITHUB_REPO_KEY);
                    if (savedRepo && appState.repos.includes(savedRepo)) {
                        console.log(`[App] Restaurando repositorio guardado: ${savedRepo}`);
                        document.getElementById('repo-select').value = savedRepo;
                        await handleRepoChange(savedRepo); 
                    }
                } else {
                    console.warn('[App] El token guardado es inválido o expiró. Limpiando sesión.');
                    _reallyLogout(); 
                }
            } else {
                console.log('[App] No se encontró sesión guardada. Mostrando login.');
                appState.view = 'login'; 
                renderApp(); 
            }
        }
        
        async function handleLogin() {
            const tokenInput = document.getElementById('token-input');
            const token = tokenInput.value;
            if (!token) {
                showConfirmModal({ title: "Token Requerido", message: "Por favor, introduce un token de GitHub para continuar.", confirmText: "Entendido", confirmClass: "bg-blue-600", onConfirm: () => {} });
                return;
            }
            GITHUB_TOKEN = token;
            const user = await githubApiFetch('/user');
            if (user) {
                GITHUB_USER = user.login;
                console.log(`[Login] Login exitoso. Guardando sesión para ${GITHUB_USER}.`);
                localStorage.setItem(GITHUB_TOKEN_KEY, token);
                localStorage.setItem(GITHUB_USER_KEY, GITHUB_USER);
                appState.view = 'browser';
                renderApp();
                fetchRepos();
            }
        }

        function logout() {
             if (appState.isDirty) {
                showConfirmModal({ title: '¿Cerrar Sesión?', message: 'Tienes cambios locales sin guardar. ¿Estás seguro de que quieres salir y perderlos?', note: 'Los cambios no se guardarán en GitHub.', confirmText: 'Sí, Salir y Descartar', confirmClass: 'bg-red-600', onConfirm: _reallyLogout });
            } else {
                _reallyLogout();
            }
        }

        function _reallyLogout() {
            console.log('[Auth] Cerrando sesión y limpiando localStorage.');
            GITHUB_TOKEN = ''; GITHUB_USER = '';
            localStorage.removeItem(GITHUB_TOKEN_KEY);
            localStorage.removeItem(GITHUB_USER_KEY);
            localStorage.removeItem(GITHUB_REPO_KEY);
            Object.assign(appState, {
                loading: false, view: 'login', isDirty: false, pendingChangesLog: [], 
                repos: [], selectedRepo: '', currentPath: '', selectedFile: '',
                currentSha: '', data: null, dataType: 'raw', downloadUrl: null, 
                dataStructure: 'array', selectedSubject: null, editingItem: null,
                currentImageFieldTarget: null
            });
            const tokenInput = document.getElementById('token-input');
            if(tokenInput) tokenInput.value = '';
            renderApp();
        }

        function goBackToBrowser() {
             if (appState.isDirty) {
                showConfirmModal({ title: '¿Cambiar de Archivo?', message: 'Tienes cambios locales sin guardar. ¿Estás seguro de que quieres salir y perderlos?', note: 'Los cambios no se guardarán en GitHub.', confirmText: 'Sí, Salir y Descartar', confirmClass: 'bg-yellow-600', onConfirm: _reallyGoBackToBrowser });
            } else {
                _reallyGoBackToBrowser();
            }
        }
        
        async function _reallyGoBackToBrowser() {
            console.log('[Navegación] Volviendo al explorador de archivos.');
            appState.view = 'browser';
            appState.selectedFile = ''; appState.currentSha = ''; appState.data = null;
            appState.dataType = 'raw'; appState.downloadUrl = null; appState.selectedSubject = null;
            appState.editingItem = null; appState.isDirty = false; appState.pendingChangesLog = []; 
            appState.currentImageFieldTarget = null;
            renderApp(); 
            try {
                const savedRepo = localStorage.getItem(GITHUB_REPO_KEY);
                if (savedRepo) {
                    document.getElementById('repo-select').value = savedRepo;
                    await loadRepoPath(appState.currentPath); 
                } else {
                    document.getElementById('repo-actions-container').classList.add('hidden');
                    document.getElementById('repo-select').value = '';
                }
            } catch (e) {
                console.warn("[Navegación] No se pudo resetear la vista de browser:", e);
            }
        }

        // --- 2. LÓGICA DE NAVEGACIÓN (REPOS Y ARCHIVOS) ---
        async function fetchRepos() {
             const repoSelect = document.getElementById('repo-select');
            if (!repoSelect) return;
            const repos = await githubApiFetch('/user/repos?type=all&sort=updated');
            if (!repos) return;
            appState.repos = repos.map(repo => repo.full_name);
            repoSelect.innerHTML = '<option value="">Selecciona un repositorio...</option>';
            appState.repos.forEach(repoName => {
                const option = new Option(repoName, repoName);
                repoSelect.add(option);
            });
            repoSelect.disabled = false;
        }

        async function handleRepoChange(repoFullName) {
            console.log(`[Navegación] Cambiando a repo: ${repoFullName}`);
            appState.selectedRepo = repoFullName;
            appState.currentPath = ''; 
            
            const actionsContainer = document.getElementById('repo-actions-container');
            const fileListContainer = document.getElementById('file-list-container');
            const loadingText = document.getElementById('file-list-loading');

            if (!repoFullName) {
                actionsContainer.classList.add('hidden');
                fileListContainer.classList.add('hidden'); 
                loadingText.textContent = 'Selecciona un repositorio para ver los archivos...';
                loadingText.classList.remove('hidden'); 
                localStorage.removeItem(GITHUB_REPO_KEY); 
                return;
            }
            
            localStorage.setItem(GITHUB_REPO_KEY, repoFullName);
            actionsContainer.classList.remove('hidden');
            document.getElementById('create-file-button').disabled = false; 
            await loadRepoPath(''); 
        }

        async function loadRepoPath(path) {
            console.log(`[Navegación] Cargando ruta: /${path}`);
            appState.currentPath = path; 

            const fileListContainer = document.getElementById('file-list-container');
            const loadingText = document.getElementById('file-list-loading');
            
            loadingText.textContent = 'Cargando contenido...';
            loadingText.classList.remove('hidden');
            fileListContainer.classList.add('hidden');
            fileListContainer.innerHTML = ''; 

            const uploadLabel = document.getElementById('upload-file-label');
            const createLabel = document.getElementById('create-file-label');
            const currentFolder = path || 'raíz';
            uploadLabel.textContent = `Subir Archivo a: /${currentFolder}`;
            createLabel.textContent = `Crear archivo en: /${currentFolder}`;

            renderBreadcrumbs(); 

            const data = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${path}`);
            
            if (!data) { 
                loadingText.textContent = 'Error al cargar el contenido de la carpeta.';
                loadingText.classList.remove('hidden');
                return;
            }
            
            if (!Array.isArray(data)) {
                console.error("[Navegación] La respuesta de la API no fue un array:", data);
                loadingText.textContent = 'Error: La respuesta de la API no fue la esperada.';
                loadingText.classList.remove('hidden');
                return;
            }

            const folders = data.filter(item => item.type === 'dir').sort((a, b) => a.name.localeCompare(b.name));
            const files = data.filter(item => item.type === 'file').sort((a, b) => a.name.localeCompare(b.name));
            const items = [...folders, ...files]; 

            loadingText.classList.add('hidden');
            
            if (items.length === 0) {
                 loadingText.textContent = 'Esta carpeta está vacía.';
                 loadingText.classList.remove('hidden');
                 fileListContainer.classList.add('hidden');
                 return;
            }

            fileListContainer.classList.remove('hidden');

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'file-list-item';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'file-list-name';
                
                let icon = '';
                if (item.type === 'dir') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-yellow-500"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>';
                    nameEl.onclick = () => app.loadRepoPath(item.path);
                } else {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>';
                    nameEl.onclick = () => app.loadFileContent(item.path);
                }
                
                nameEl.innerHTML = `${icon}<span>${item.name}</span>`;
                itemEl.appendChild(nameEl);

                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'file-actions';

                if (item.type === 'file') {
                    const duplicateBtn = document.createElement('button');
                    duplicateBtn.className = "duplicate-btn text-gray-400 hover:text-blue-600";
                    duplicateBtn.title = `Duplicar ${item.name}`;
                    duplicateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M7 3a2 2 0 00-2 2v10a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2H7z"></path><path d="M13 3a2 2 0 012 2v10a2 2 0 01-2 2h-1v-2h1V5h-6v.5a.5.5 0 001 0V5h1.5a.5.5 0 000-1H13z"></path></svg>';
                    duplicateBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        app.showDuplicateFileModal(item.path, item.name);
                    };
                    actionsContainer.appendChild(duplicateBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "delete-btn text-gray-400 hover:text-red-600";
                    deleteBtn.title = `Eliminar ${item.name}`;
                    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1H8.75zM10 4.5a.75.75 0 01.75.75v10.5a.75.75 0 01-1.5 0V5.25A.75.75 0 0110 4.5zM7.5 3.75A1.25 1.25 0 018.75 2.5h2.5A1.25 1.25 0 0112.5 3.75v.443c-.621.048-1.25.105-1.875.162h-1.25c-.625-.057-1.254-.114-1.875-.162V3.75z" clip-rule="evenodd"></path></svg>';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        app.showDeleteFileConfirmation(item.path, item.sha);
                    };
                    actionsContainer.appendChild(deleteBtn);
                }

                itemEl.appendChild(actionsContainer);
                fileListContainer.appendChild(itemEl);
            });
        }

        function renderBreadcrumbs() {
            const container = document.getElementById('breadcrumb-container');
            container.innerHTML = ''; 

            const rootLink = document.createElement('a');
            rootLink.href = "#";
            rootLink.textContent = appState.selectedRepo.split('/')[1]; 
            rootLink.onclick = (e) => {
                e.preventDefault();
                app.loadRepoPath('');
            };
            container.appendChild(rootLink);

            const parts = appState.currentPath.split('/').filter(p => p.length > 0);
            let currentPath = '';
            parts.forEach((part, index) => {
                currentPath += (currentPath ? '/' : '') + part;
                
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                container.appendChild(separator);

                const partSpan = document.createElement('span');
                const partLink = document.createElement('a');
                partLink.href = "#";
                partLink.textContent = part;
                
                if (index === parts.length - 1) { 
                    partLink.onclick = (e) => e.preventDefault();
                } else {
                    const path = currentPath; 
                    partLink.onclick = (e) => {
                        e.preventDefault();
                        app.loadRepoPath(path);
                    };
                }
                partSpan.appendChild(partLink);
                container.appendChild(partSpan);
            });
        }

        // --- 3. LÓGICA DE CARGA Y ANÁLISIS DE DATOS ---
        async function loadFileContent(filePath) {
            if (!filePath) { console.error("[Loader] loadFileContent fue llamado sin filePath."); return; }
            console.log(`[Loader] Cargando contenido para: ${filePath}`);
            appState.selectedFile = filePath;
            appState.data = null; appState.dataType = 'raw'; appState.downloadUrl = null;
            appState.isDirty = false; appState.pendingChangesLog = [];
            appState.loading = true; renderApp();

            const fileData = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${filePath}`);
            
            appState.loading = false; 
            
            if (!fileData) { 
                renderApp(); 
                _reallyGoBackToBrowser(); 
                return; 
            }

            appState.currentSha = fileData.sha;
            appState.downloadUrl = fileData.download_url;
            const fileExt = filePath.split('.').pop().toLowerCase();

            try {
                const codeExt = ['html', 'css', 'js', 'ts', 'jsx', 'tsx', 'py', 'java', 'c', 'cpp', 'h', 'cs', 'go', 'rb', 'php', 'txt', 'md'];

                if (fileExt === 'json' || fileExt === 'jsonc' || fileExt === 'csv') {
                    console.log(`[Loader] Detectado tipo: ${fileExt} (Editable JSON/CSV)`);
                    let decodedContent;
                    try { 
                         decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                    } catch (decodeError) {
                         console.error("Error decoding file content:", decodeError);
                         throw new Error("No se pudo decodificar el contenido del archivo.");
                    }

                    if (fileExt === 'csv') {
                        appState.data = csvToJSON(decodedContent); 
                    } else {
                        try { 
                             const cleanedContent = decodedContent.replace(/\/\/.*|\/\*[\s\S]*?\*\//g, '');
                             appState.data = JSON.parse(cleanedContent);
                        } catch(parseError) {
                             console.error(`[Loader] Error al parsear JSON/JSONC: ${filePath}`, parseError);
                             throw new Error("El archivo JSON/JSONC parece tener un formato inválido.");
                        }
                    }
                    appState.dataType = 'json-csv';
                    analyzeDataStructure(); 
                    appState.view = 'editor';
                    renderApp(); 
                } 
                else if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(fileExt)) {
                    console.log(`[Loader] Detectado tipo: Imagen (${fileExt})`);
                    appState.dataType = 'raw'; 
                    appState.view = 'editor'; 
                    renderApp(); 
                    renderImageViewer(appState.downloadUrl); 
                }
                 else if (fileExt === 'pdf') {
                    console.log(`[Loader] Detectado tipo: PDF`);
                    appState.dataType = 'raw';
                    appState.view = 'editor';
                    renderApp();
                    renderPdfPreview(appState.downloadUrl, fileData.html_url); 
                 }
                else if (codeExt.includes(fileExt)) {
                    console.log(`[Loader] Detectado tipo: Código/Texto (${fileExt})`);
                    let decodedContent;
                     try { 
                         decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                     } catch (decodeError) {
                         console.error("Error decoding file content:", decodeError);
                         throw new Error("No se pudo decodificar el contenido del archivo.");
                     }
                     appState.data = decodedContent; 
                     appState.dataType = 'raw';
                     appState.view = 'editor';
                     renderApp();
                     try { 
                        renderCodePreview(appState.data, fileExt); 
                     } catch (renderError) {
                         console.error("[Loader] Error rendering code preview:", renderError);
                         document.getElementById('preview-container').innerHTML = `<p class="text-red-500 font-semibold">Error al previsualizar el código.</p><pre>${appState.data.replace(/</g, "&lt;")}</pre>`;
                     }
                }
                else {
                    console.log(`[Loader] Detectado tipo: Otro (${fileExt}) - Mostrar enlace descarga.`);
                    appState.dataType = 'raw';
                    appState.view = 'editor';
                    renderApp();
                    renderDownloadLink(appState.downloadUrl, filePath, fileData.html_url);
                }
            } catch (error) { 
                console.error(`[Loader] Error fatal al procesar el archivo: ${filePath}`, error);
                showConfirmModal({ title: "Error al Procesar Archivo", message: `Ocurrió un error inesperado al procesar el archivo:\n${error.message}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                 _reallyGoBackToBrowser(); 
            }
        }


        function analyzeDataStructure() {
            if (typeof appState.data === 'object' && !Array.isArray(appState.data) && appState.data !== null) {
                const keys = Object.keys(appState.data);
                if (keys.length > 0 && Array.isArray(appState.data[keys[0]])) {
                    appState.dataStructure = 'object-of-arrays';
                    appState.selectedSubject = keys[0]; 
                    return;
                }
            }
            appState.dataStructure = 'array';
            appState.selectedSubject = null;
        }

        // --- 4. LÓGICA DEL EDITOR Y PREVISUALIZADOR ---
        function renderEditor() { renderTabs(); renderItemsList(); renderAddItemForm(); }
        function renderTabs() { 
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = '';
            if (appState.dataStructure !== 'object-of-arrays') {
                tabsContainer.classList.add('hidden');
                return;
            }
            tabsContainer.classList.remove('hidden');
            const subjects = Object.keys(appState.data);
            subjects.forEach(subject => {
                const isSelected = subject === appState.selectedSubject;
                const tabClasses = isSelected ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100 shadow-sm border border-gray-200';
                const tab = document.createElement('button');
                tab.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
                tab.className = `px-4 py-2 font-medium rounded-md ${tabClasses}`;
                tab.onclick = () => { appState.selectedSubject = subject; renderEditor(); };
                tabsContainer.appendChild(tab);
            });
         }
        function renderItemsList() { 
            const itemsListContainer = document.getElementById('items-list');
            itemsListContainer.className = "grid grid-cols-1 xl:grid-cols-3 gap-6"; 
            itemsListContainer.innerHTML = '';
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const title = (appState.dataStructure === 'object-of-arrays') ? `Items de "${appState.selectedSubject}"` : 'Items del Archivo';
            document.getElementById('items-list-title').textContent = title;
            if (!items || !Array.isArray(items) || items.length === 0) {
                itemsListContainer.innerHTML = '<p class="text-gray-500 lg:col-span-2">No hay items en esta categoría.</p>';
                return;
            }
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const filteredItems = items.filter(item => {
                if (!searchTerm) return true;
                 if (typeof item !== 'object' || item === null) return false;
                return Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm));
            });
            if (filteredItems.length === 0 && searchTerm) {
                 itemsListContainer.innerHTML = `<p class="text-gray-500 lg:col-span-2">No se encontraron items que coincidan con "${searchTerm}".</p>`;
             } else if (filteredItems.length === 0) {
                 itemsListContainer.innerHTML = '<p class="text-gray-500 lg:col-span-2">No hay items para mostrar.</p>';
             }
            filteredItems.forEach((item) => {
                 if (typeof item !== 'object' || item === null) {
                     console.warn("[Render] Se encontró un item no válido en los datos:", item);
                     return; 
                 }
                const originalIndex = items.indexOf(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col hover:shadow-lg transition-shadow';
                let videoPreviewHtml = '';
                if (item.video_link && typeof item.video_link === 'string') {
                    const embedUrl = getEmbeddableDriveUrl(item.video_link);
                    if (embedUrl) {
                        videoPreviewHtml = `
                            <div class="video-placeholder aspect-video w-full bg-gray-800 cursor-pointer flex items-center justify-center relative"
                                data-embed-url="${embedUrl + '?autoplay=1'}" onclick="app.loadVideo(this)">
                                <svg class="w-16 h-16 text-white text-opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                                <span class="absolute bottom-2 right-2 text-xs text-white bg-black bg-opacity-50 px-2 py-1 rounded">Cargar video</span>
                            </div>`;
                    }
                }
                let cardContentHtml = '<div class="p-4 flex-grow">';
                for (const [key, value] of Object.entries(item)) {
                    if (key.toLowerCase() === 'title') {
                        cardContentHtml += `<h3 class="text-lg font-semibold text-blue-700 mb-1 break-words">${value}</h3>`;
                    } else if (key.toLowerCase() === 'video_link') {
                        cardContentHtml += `<a href="${value}" target="_blank" class="text-sm text-blue-500 hover:underline break-all mt-2 inline-block">Ver Video</a>`;
                    } else if (key.toLowerCase().includes('imagen') || key.toLowerCase().includes('img') || key.toLowerCase().includes('foto') || key.toLowerCase().includes('doc')) { 
                        if (String(value).startsWith('http')) {
                            if (String(value).match(/\.(jpeg|jpg|gif|png|svg|webp)$/i)) {
                                cardContentHtml += `<img src="${value}" alt="Vista previa ${key}" class="w-full h-auto rounded-md my-2 border border-gray-200" onerror="this.style.display='none'; console.warn('Error cargando imagen:', this.src)">`;
                            } else {
                                cardContentHtml += `<a href="${value}" target="_blank" class="text-sm text-blue-500 hover:underline break-all mt-2 inline-block">Ver Archivo: ${key}</a>`;
                            }
                        } else if(value) { 
                             cardContentHtml += `<p class="text-sm text-gray-600 break-words"><strong>${key}:</strong> ${value}</p>`;
                        }
                    } else if (key.toLowerCase() !== 'description') {
                         if(value || value === 0) { 
                             cardContentHtml += `<p class="text-sm text-gray-600 break-words"><strong>${key}:</strong> ${value}</p>`;
                         }
                    }
                }
                if (item.description) {
                     cardContentHtml += `<p class="text-sm text-gray-700 mt-2 break-words"><strong>Descripción:</strong> ${item.description}</p>`;
                }
                cardContentHtml += '</div>';
                itemEl.innerHTML = `
                    ${videoPreviewHtml}
                    ${cardContentHtml}
                    <div class="p-4 bg-gray-50 border-t border-gray-100 flex gap-3">
                        <button data-index="${originalIndex}" class="edit-btn flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 bg-yellow-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            Editar
                        </button>
                        <button data-index="${originalIndex}" class="delete-btn flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            Eliminar
                        </button>
                    </div>`;
                itemsListContainer.appendChild(itemEl);
            });
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = (e) => showEditModal(e.currentTarget.dataset.index);
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = (e) => showDeleteConfirmation(e.currentTarget.dataset.index);
            });
         }
        function renderAddItemForm() { 
            const formContainer = document.getElementById('add-item-form-container');
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const title = (appState.dataStructure === 'object-of-arrays') ? `Añadir a "${appState.selectedSubject}"` : 'Añadir Nuevo Item';
            let schema = null;
            if (items && items.length > 0) {
                 if (typeof items[0] === 'object' && items[0] !== null) { schema = items[0]; }
            } else if (appState.dataStructure === 'object-of-arrays') {
                for (const key in appState.data) {
                    if (appState.data[key].length > 0 && typeof appState.data[key][0] === 'object' && appState.data[key][0] !== null) {
                        schema = appState.data[key][0]; break;
                    }
                }
            }
            if (!schema) {
                formContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3><p class="text-gray-500">No se puede generar el formulario porque el archivo o la categoría están vacíos, o los items no son objetos válidos. Intenta usar "Administrar Campos" (⚙️) para añadir el primer campo.</p>`;
                return;
            }
            let formHtml = `<h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3><form id="add-form" class="space-y-4">`;
            for (const key of Object.keys(schema)) {
                formHtml += generateFormField(key, '', `add-`);
            }
            formHtml += `<button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Añadir Item</button></form>`;
            formContainer.innerHTML = formHtml;
            document.getElementById('add-form').onsubmit = handleAddItem;
         }
        function renderImageViewer(imageUrl) {
            console.log('[Preview] Renderizando imagen:', imageUrl);
            document.getElementById('preview-container').innerHTML = `<img src="${imageUrl}" alt="Previsualización de ${appState.selectedFile}">`;
         }
        function renderCodePreview(content, language) {
             console.log(`[Preview] Renderizando código (lenguaje: ${language})`);
             const previewContainer = document.getElementById('preview-container');
             const escapedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             previewContainer.innerHTML = `
                <button onclick="app.showCodeEditor()" class="absolute top-4 right-4 z-10 flex items-center gap-2 px-3 py-2 bg-yellow-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    Editar Archivo
                </button>
                <pre><code class="language-${language}">${escapedContent}</code></pre>`;
             Prism.highlightAllUnder(previewContainer);
        }
        function renderPdfPreview(downloadUrl, githubUrl) {
            console.log('[Preview] Renderizando PDF:', downloadUrl);
             document.getElementById('preview-container').innerHTML = `
                 <iframe src="${downloadUrl}" title="Previsualización PDF"></iframe>
                 <p class="mt-4 text-sm text-gray-600">Si el PDF no carga, puedes <a href="${downloadUrl}" download="${appState.selectedFile}" class="text-blue-600 hover:underline">descargarlo</a> o <a href="${githubUrl}" target="_blank" class="text-blue-600 hover:underline">verlo en GitHub</a>.</p>`;
         }
        function renderDownloadLink(downloadUrl, fileName, githubUrl) {
             console.log(`[Preview] Renderizando enlace de descarga para: ${fileName}`);
             document.getElementById('preview-container').innerHTML = `
                <div class="text-center p-8">
                     <h3 class="text-lg font-semibold text-gray-800 mb-4">Previsualización no disponible</h3>
                     <p class="text-gray-600 mb-6">No se puede mostrar una vista previa directa para archivos de tipo "${fileName.split('.').pop()}" en esta aplicación.</p>
                     <a href="${downloadUrl}" download="${fileName}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 mr-3">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                         Descargar Archivo
                     </a>
                     <a href="${githubUrl}" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.87-.31-1.59-.8-2.15 2.64-.3 5.4-1.32 5.4-5.86 0-1.3-.47-2.36-1.22-3.21.13-.3.53-1.52-.11-3.17 0 0-1-.32-3.3 1.23a11.5 11.5 0 0 0-6 0C3.08 1.7 2.08 2.02 2.08 2.02c-.64 1.65-.24 2.87-.12 3.17-.75.85-1.22 1.91-1.22 3.21 0 4.55 2.76 5.56 5.4 5.86-.45.39-.85 1.12-.85 2.27 0 1.64-.01 2.95-.01 3.36 0 .22-.15.47-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z" /></svg>
                         Ver en GitHub
                     </a>
                 </div>`;
         }

        // --- 5. LÓGICA DE ACCIONES (CRUD - JSON/CSV) ---
        function generateFormField(key, value, prefix = '') { 
            const id = `${prefix}${key}`;
            let field = '';
            const stringValue = (value === null || value === undefined) ? '' : String(value);
            const keyLower = key.toLowerCase();
            if (keyLower.includes('imagen') || keyLower.includes('img') || keyLower.includes('foto') || keyLower.includes('icon') || keyLower.includes('doc') || keyLower.includes('archivo')) {
                field = `
                    <div class="flex items-center gap-2">
                        <input type="url" id="${id}" value="${stringValue}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://... o sube un archivo">
                        <button type="button" onclick="app.triggerImageUpload('${id}')" class="p-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400" title="Subir Archivo (Imagen, PDF, Doc...)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
            } else if (keyLower.includes('description') || stringValue.length > 80) {
                field = `<textarea id="${id}" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">${stringValue}</textarea>`;
            } else if (keyLower.includes('link') || keyLower.includes('url')) {
                field = `<input type="url" id="${id}" value="${stringValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">`;
            } else {
                field = `<input type="text" id="${id}" value="${stringValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">`;
            }
            return `<div><label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${key.charAt(0).toUpperCase() + key.slice(1)}</label>${field}</div>`;
         }
        function handleAddItem(e) { 
            e.preventDefault();
             if (appState.dataType !== 'json-csv') { console.error("[CRUD] Intento de añadir item fuera del modo editor JSON/CSV."); return; }
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            let schema = null;
             if (items.length > 0 && typeof items[0] === 'object' && items[0] !== null) { schema = items[0];
            } else if (appState.dataStructure === 'object-of-arrays') {
                 for(const key in appState.data) {
                    if (appState.data[key].length > 0 && typeof appState.data[key][0] === 'object' && appState.data[key][0] !== null) {
                        schema = appState.data[key][0]; break;
                    }
                 }
            }
            if (!schema) {
                console.error("[CRUD] No se puede añadir item: estructura desconocida o no válida.");
                showConfirmModal({ title: "Error", message: "No se puede añadir item: estructura desconocida o los items existentes no son objetos válidos. Intenta añadir un campo primero si el archivo está vacío.", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                return;
            }
            const newItem = {};
            for (const key of Object.keys(schema)) { newItem[key] = document.getElementById(`add-${key}`).value; }
            if (appState.dataStructure === 'object-of-arrays') { appState.data[appState.selectedSubject].push(newItem);
            } else { appState.data.push(newItem); }
            appState.isDirty = true;
            const title = newItem.title || newItem.name || `Índice ${items.length - 1}`;
            appState.pendingChangesLog.push(`Item añadido: "${title}"`);
            console.log(`[CRUD] Item añadido localmente: ${title}`);
            renderApp(); renderEditor(); e.target.reset();
         }
        function showEditModal(index) { 
             if (appState.dataType !== 'json-csv') { console.error("[CRUD] Intento de editar fuera del modo editor JSON/CSV."); return; }
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const item = items[index];
             if (typeof item !== 'object' || item === null) {
                 console.error("[CRUD] El item a editar no es un objeto válido:", item);
                 showConfirmModal({title: "Error", message: "No se puede editar este item porque no tiene un formato válido.", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: ()=>{}});
                 return;
             }
            appState.editingItem = { index: parseInt(index) };
            let formHtml = '';
            for (const [key, value] of Object.entries(item)) { formHtml += generateFormField(key, value, 'edit-'); }
            formHtml += `
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="app.hideEditModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Guardar Cambios</button>
                </div>`;
            document.getElementById('edit-form').innerHTML = formHtml;
            document.getElementById('edit-form').onsubmit = handleEditItem;
            document.getElementById('edit-modal-title').textContent = `Editar Item (Índice ${index})`;
            document.getElementById('edit-modal').classList.remove('hidden');
         }
        function hideEditModal() { 
            appState.editingItem = null;
            document.getElementById('edit-modal').classList.add('hidden');
         }
        function handleEditItem(e) { 
            e.preventDefault();
             if (!appState.editingItem || appState.dataType !== 'json-csv') return;
            const { index } = appState.editingItem;
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const oldItem = items[index];
             if (typeof oldItem !== 'object' || oldItem === null) { console.error("[CRUD] El item original a editar no es un objeto válido:", oldItem); hideEditModal(); return; }
            const updatedItem = {};
            for (const key of Object.keys(oldItem)) { updatedItem[key] = document.getElementById(`edit-${key}`).value; }
            if (appState.dataStructure === 'object-of-arrays') { appState.data[appState.selectedSubject][index] = updatedItem;
            } else { appState.data[index] = updatedItem; }
            appState.isDirty = true;
            const title = updatedItem.title || updatedItem.name || `Índice ${index}`;
            appState.pendingChangesLog.push(`Item editado: "${title}"`);
            console.log(`[CRUD] Item editado localmente: ${title}`);
            renderApp(); renderEditor(); hideEditModal();
         }
        function showDeleteConfirmation(index) { 
             if (appState.dataType !== 'json-csv') { console.error("[CRUD] Intento de eliminar fuera del modo editor JSON/CSV."); return; }
            appState.editingItem = { index: parseInt(index) };
            showConfirmModal({
                title: 'Confirmar Eliminación de Item',
                message: '¿Estás seguro de que quieres eliminar este item del archivo JSON/CSV?',
                note: 'Esto solo se borrará localmente. Presiona "Guardar Cambios" para hacerlo permanente.',
                confirmText: 'Sí, Eliminar Item',
                confirmClass: 'bg-red-600 hover:bg-red-700 focus:ring-red-400',
                onConfirm: handleDeleteItem
            });
         }
        function handleDeleteItem() { 
             if (!appState.editingItem || appState.dataType !== 'json-csv') return;
            const { index } = appState.editingItem;
            appState.isDirty = true;
            const items = (appState.dataStructure === 'object-of-arrays') ? appState.data[appState.selectedSubject] : appState.data;
            const deletedItem = items[index]; 
             const title = (typeof deletedItem === 'object' && deletedItem !== null) ? (deletedItem.title || deletedItem.name || `Índice ${index}`) : `Índice ${index}`;
            appState.pendingChangesLog.push(`Item eliminado: "${title}"`);
            console.log(`[CRUD] Item eliminado localmente: ${title}`);
            if (appState.dataStructure === 'object-of-arrays') { appState.data[appState.selectedSubject].splice(index, 1);
            } else { appState.data.splice(index, 1); }
            appState.editingItem = null; 
            renderApp(); renderEditor(); 
         }

        // --- LÓGICA DE ELIMINACIÓN DE ARCHIVOS ---
        function showDeleteFileConfirmation(path, sha) {
            console.log(`[Delete] Solicitando confirmación para borrar: ${path} (SHA: ${sha})`);
            showConfirmModal({
                title: 'Confirmar Eliminación de Archivo',
                message: `¿Estás seguro de que quieres eliminar el archivo "${path}"?`,
                note: 'Esta acción es permanente y no se puede deshacer.',
                confirmText: 'Sí, Eliminar Archivo',
                confirmClass: 'bg-red-600 hover:bg-red-700 focus:ring-red-400',
                onConfirm: () => handleDeleteFile(path, sha)
            });
        }
        async function handleDeleteFile(path, sha) {
            if (!path || !sha) { console.error("[Delete] Faltan 'path' o 'sha' para eliminar."); return; }
            console.log(`[Delete] Enviando petición para eliminar: ${path}`);
            const endpoint = `/repos/${appState.selectedRepo}/contents/${path}`;
            const options = {
                method: 'DELETE',
                body: JSON.stringify({ message: `Eliminado ${path} desde la plataforma`, sha: sha })
            };
            const result = await githubApiFetch(endpoint, options);
            if (result !== undefined) { 
                console.log(`[Delete] Archivo "${path}" eliminado con éxito.`);
                showConfirmModal({ title: "Éxito", message: `¡Archivo "${path}" eliminado con éxito!`, confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
                loadRepoPath(appState.currentPath); 
            } else {
                console.error(`[Delete] Error al eliminar el archivo "${path}".`);
            }
        }

        // --- 6. LÓGICA DE GUARDADO (JSON/CSV) ---
        function saveAllChanges() { 
             if (appState.dataType !== 'json-csv') { console.warn("[Guardado] Intento de guardar cambios en un archivo no editable."); return; }
            if (!appState.isDirty || appState.pendingChangesLog.length === 0) { return; }
            showReviewChangesModal();
         }
        function showReviewChangesModal() { 
            const listEl = document.getElementById('pending-changes-list');
            listEl.innerHTML = ''; 
            appState.pendingChangesLog.forEach(logEntry => {
                const li = document.createElement('li');
                li.textContent = logEntry;
                listEl.appendChild(li);
            });
            document.getElementById('review-changes-modal').classList.remove('hidden');
         }
        function hideReviewChangesModal() { 
            document.getElementById('review-changes-modal').classList.add('hidden');
         }
        async function _reallySaveAllChanges() { 
            console.log('[Guardado] Confirmado. Guardando todos los cambios en GitHub...');
            const success = await saveChangesToGitHub(appState.data);
            if (success) {
                appState.isDirty = false;
                appState.pendingChangesLog = []; 
                hideReviewChangesModal(); 
                renderApp(); 
            } else {
                console.error("[Guardado] No se pudieron guardar los cambios.");
                 showConfirmModal({title: "Error al Guardar", message: "No se pudieron guardar los cambios en GitHub. Revisa la consola para más detalles.", confirmText: "Entendido", confirmClass:"bg-red-600", onConfirm: ()=>{}});
            }
         }
        async function saveChangesToGitHub(newData) { 
             if (appState.dataType !== 'json-csv') { console.error("[Guardado] Intento de guardar cambios en un archivo no editable."); return false; }
            console.log(`[Guardado] Intentando guardar cambios en: ${appState.selectedFile}`);
            const commitMessage = `Actualizado ${appState.selectedFile} desde la plataforma de admin`;
            let newContent = '';
            if (appState.selectedFile.toLowerCase().endsWith('.csv')) {
                newContent = jsonToCSV(newData);
            } else {
                newContent = JSON.stringify(newData, null, 2); 
            }
             if (appState.selectedFile.toLowerCase().endsWith('.csv') && !newContent) { return false; }
            const newContentBase64 = btoa(unescape(encodeURIComponent(newContent)));
            const endpoint = `/repos/${appState.selectedRepo}/contents/${appState.selectedFile}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({ message: commitMessage, content: newContentBase64, sha: appState.currentSha })
            };
            const result = await githubApiFetch(endpoint, options);
             if (result === undefined) return false;
            if (result && result.content) {
                console.log(`[Guardado] Éxito. Nuevo SHA: ${result.content.sha}`);
                appState.currentSha = result.content.sha;
                appState.data = newData; 
                renderEditor();
                showConfirmModal({ title: "Éxito", message: "¡Cambios guardados en GitHub con éxito!", confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
                return true; 
            } else if (result === null) {
                console.warn("[Guardado] Guardado exitoso (204), recargando SHA.");
                const fileData = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${appState.selectedFile}`);
                if (fileData) {
                    appState.currentSha = fileData.sha;
                    appState.data = newData;
                    renderEditor(); 
                    showConfirmModal({ title: "Éxito", message: "¡Cambios guardados en GitHub con éxito!", confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
                    return true;
                 } else {
                     console.error("[Guardado] Error al recargar SHA después de un 204.");
                     return false;
                 }
            }
            console.error('[Guardado] Falló el guardado. La respuesta de la API no fue la esperada.');
            return false; 
         }

        // --- Lógica del Editor de Código Universal ---
        function showCodeEditor() {
            if (appState.dataType !== 'raw' || typeof appState.data !== 'string') {
                console.error("[Editor Código] Se intentó editar un archivo no-texto.");
                return;
            }
            console.log(`[Editor Código] Abriendo editor para ${appState.selectedFile}`);
            document.getElementById('code-edit-modal-title').textContent = `Editar: ${appState.selectedFile}`;
            document.getElementById('code-editor-textarea').value = appState.data;
            document.getElementById('code-edit-modal').classList.remove('hidden');
        }
        function hideCodeEditor() {
            document.getElementById('code-edit-modal').classList.add('hidden');
        }
        async function handleSaveCodeFile() {
            const newContent = document.getElementById('code-editor-textarea').value;
            if (typeof newContent !== 'string') return;
            console.log(`[Editor Código] Guardando cambios en ${appState.selectedFile}`);
            const saveBtn = document.getElementById('code-edit-save-btn');
            saveBtn.disabled = true; saveBtn.textContent = 'Guardando...';
            const commitMessage = `Actualizado ${appState.selectedFile} desde la plataforma`;
            const newContentBase64 = btoa(unescape(encodeURIComponent(newContent)));
            const endpoint = `/repos/${appState.selectedRepo}/contents/${appState.selectedFile}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({ message: commitMessage, content: newContentBase64, sha: appState.currentSha })
            };
            const result = await githubApiFetch(endpoint, options);
            saveBtn.disabled = false; saveBtn.textContent = 'Guardar Cambios';
            if (result && result.content) {
                console.log(`[Editor Código] Éxito. Nuevo SHA: ${result.content.sha}`);
                appState.currentSha = result.content.sha;
                appState.data = newContent; 
                hideCodeEditor();
                const fileExt = appState.selectedFile.split('.').pop().toLowerCase();
                renderCodePreview(appState.data, fileExt);
                showConfirmModal({ title: "Éxito", message: "¡Cambios guardados en GitHub con éxito!", confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
            } else {
                console.error('[Editor Código] Falló el guardado.');
            }
        }

        // --- Lógica de "Crear Nuevo Archivo" ---
        async function createNewFile() {
            const fileNameInput = document.getElementById('new-file-name');
            const fileName = fileNameInput.value;
            if (!fileName || !appState.selectedRepo || fileName.includes('/') || fileName.startsWith('.')) {
                showConfirmModal({ title: "Error", message: "Por favor, introduce un nombre de archivo válido (ej: archivo.txt, datos.json). No se permiten carpetas (/) ni nombres ocultos (.).", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                return;
            }
            const allowedExtensions = ['.json', '.csv', '.txt', '.md', '.html', '.css', '.js'];
            if (!allowedExtensions.some(ext => fileName.toLowerCase().endsWith(ext))) {
                showConfirmModal({ title: "Error", message: `El tipo de archivo no es compatible para creación. Solo se permite: ${allowedExtensions.join(', ')}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                return;
            }
            let initialContent = '';
            if (fileName.toLowerCase().endsWith('.json')) { initialContent = '[]'; } 
            else if (fileName.toLowerCase().endsWith('.csv')) { initialContent = 'id,nombre,descripcion'; } 
            else { initialContent = `<!-- Creado por la Plataforma de Administración -->\n`; }
            const fullPath = appState.currentPath ? `${appState.currentPath}/${fileName}` : fileName;
            console.log(`[Crear] Creando nuevo archivo en: ${fullPath}`);
            const commitMessage = `Creado ${fullPath} desde la plataforma`;
            const newContentBase64 = btoa(unescape(encodeURIComponent(initialContent)));
            const endpoint = `/repos/${appState.selectedRepo}/contents/${fullPath}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({ message: commitMessage, content: newContentBase64 })
            };
            const result = await githubApiFetch(endpoint, options);
             if (result === undefined) return;
            if (result && result.content) {
                console.log(`[Crear] Archivo "${fullPath}" creado con éxito.`);
                showConfirmModal({ title: "Éxito", message: `¡Archivo "${fullPath}" creado con éxito!`, confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
                fileNameInput.value = '';
                loadRepoPath(appState.currentPath); 
            } else {
                console.error(`[Crear] Error al crear el archivo. ¿Quizás ya existe?`);
                showConfirmModal({ title: "Error", message: "Error al crear el archivo. ¿Quizás ya existe?", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
            }
        }

        // --- Lógica de Duplicar Archivos ---
        function showDuplicateFileModal(originalPath, originalName) {
            const parts = originalName.split('.');
            const extension = parts.length > 1 ? `.${parts.pop()}` : '';
            const baseName = parts.join('.');
            const defaultNewName = `${baseName}-copia${extension}`;
            showInputModal({
                title: "Duplicar Archivo",
                message: `Introduce el nombre para la copia de "${originalName}":`,
                defaultValue: defaultNewName,
                confirmText: "Duplicar",
                confirmClass: "bg-blue-600 hover:bg-blue-700 focus:ring-blue-400",
                onConfirm: (newName) => {
                    if (newName && newName !== originalName) {
                        handleDuplicateFile(originalPath, newName);
                    } else if (newName === originalName) {
                         showConfirmModal({title: "Error", message: "El nombre del duplicado no puede ser igual al original.", confirmText:"Entendido", confirmClass:"bg-red-600", onConfirm: ()=>{}});
                    }
                }
            });
        }
        async function handleDuplicateFile(originalPath, newName) {
            console.log(`[Duplicar] Intentando duplicar ${originalPath} como ${newName}`);
            const fileData = await githubApiFetch(`/repos/${appState.selectedRepo}/contents/${originalPath}`);
            if (!fileData || fileData.content === undefined) { // Comprobar content por si es un archivo vacío
                console.error("[Duplicar] No se pudo obtener el contenido del archivo original.");
                 showConfirmModal({title:"Error", message:"No se pudo leer el archivo original para duplicarlo.", confirmText:"Entendido", confirmClass:"bg-red-600", onConfirm:()=>{}});
                return;
            }
            const pathParts = originalPath.split('/');
            pathParts.pop(); 
            const newPath = pathParts.length > 0 ? `${pathParts.join('/')}/${newName}` : newName;
            console.log(`[Duplicar] Creando nuevo archivo en: ${newPath}`);
            const commitMessage = `Duplicado ${originalPath} a ${newPath} desde la plataforma`;
            const endpoint = `/repos/${appState.selectedRepo}/contents/${newPath}`;
            const options = {
                method: 'PUT',
                body: JSON.stringify({ message: commitMessage, content: fileData.content })
            };
            const result = await githubApiFetch(endpoint, options);
            if (result === undefined) return; 
            if (result && result.content) {
                console.log(`[Duplicar] Archivo "${newPath}" creado con éxito.`);
                showConfirmModal({ title: "Éxito", message: `¡Archivo "${originalName}" duplicado como "${newName}" con éxito!`, confirmText: "Entendido", confirmClass: "bg-green-600", onConfirm: () => {} });
                loadRepoPath(appState.currentPath); 
            } else {
                 console.error(`[Duplicar] Error al crear el archivo duplicado. ¿Quizás ya existe?`);
                 showConfirmModal({ title: "Error", message: "Error al crear el archivo duplicado. ¿Quizás el nombre ya existe?", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
            }
        }

        // --- Lógica de "Administrar Campos" (JSON/CSV) ---
        function showSchemaModal() { 
             if (appState.dataType !== 'json-csv') {
                 console.warn("[Schema] Intento de administrar campos en un archivo no editable.");
                 showConfirmModal({title:"Acción no disponible", message:"Solo puedes administrar campos en archivos JSON o CSV.", confirmText:"Entendido", confirmClass:"bg-yellow-600", onConfirm:()=>{}});
                 return;
             }
            document.getElementById('schema-modal').classList.remove('hidden');
            document.getElementById('schema-form').onsubmit = handleAddField;
         }
        function hideSchemaModal() { 
            document.getElementById('schema-modal').classList.add('hidden');
            document.getElementById('schema-form').reset();
         }
        function handleAddField(e) { 
            e.preventDefault();
             if (appState.dataType !== 'json-csv') return;
            const newField = document.getElementById('new-field-name').value;
            const defaultValue = document.getElementById('new-field-default-value').value;
            if (!newField) {
                showConfirmModal({ title: "Error", message: "Por favor, introduce un nombre para el nuevo campo.", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                return;
            }
            console.log(`[Schema] Añadiendo campo localmente: ${newField} con valor: ${defaultValue}`);
             let newData;
             try { newData = JSON.parse(JSON.stringify(appState.data)); } 
             catch (cloneError) {
                 console.error("[Schema] Error al clonar datos:", cloneError);
                 showConfirmModal({title:"Error Interno", message:"No se pudieron procesar los datos para añadir el campo.", confirmText:"Entendido", confirmClass:"bg-red-600", onConfirm:()=>{}});
                 return;
             }
             let fieldAdded = false; 
            if (appState.dataStructure === 'object-of-arrays') {
                 if (typeof newData !== 'object' || newData === null) { console.error("[Schema] Se esperaba un objeto de arrays, pero se encontró:", newData); return; }
                Object.keys(newData).forEach(subject => {
                     if (!Array.isArray(newData[subject])) { console.warn(`[Schema] El subject "${subject}" no contiene un array.`); return; }
                    newData[subject].forEach(item => {
                         if (typeof item === 'object' && item !== null && item[newField] === undefined) { item[newField] = defaultValue; fieldAdded = true; }
                    });
                });
            } else { 
                 if (!Array.isArray(newData)) { console.error("[Schema] Se esperaba un array, pero se encontró:", newData); return; }
                newData.forEach(item => {
                     if (typeof item === 'object' && item !== null && item[newField] === undefined) { item[newField] = defaultValue; fieldAdded = true; }
                });
            }
             if (!fieldAdded) {
                 console.log("[Schema] No se añadió el campo (ya existía o no había items válidos).");
                  showConfirmModal({ title: "Campo no Añadido", message: `El campo "${newField}" ya existía en todos los items válidos o no había items donde añadirlo.`, confirmText: "Entendido", confirmClass: "bg-blue-600", onConfirm: () => {} });
                  hideSchemaModal(); return;
             }
            appState.data = newData; appState.isDirty = true;
            appState.pendingChangesLog.push(`Campo añadido a todos: "${newField}"`);
            hideSchemaModal(); renderApp(); renderEditor(); 
            showConfirmModal({ title: "Éxito Local", message: `¡Campo "${newField}" añadido localmente! Presiona "Guardar Cambios" para aplicar en GitHub.`, confirmText: "Entendido", confirmClass: "bg-blue-600", onConfirm: () => {} });
         }


        // --- LÓGICA DE UTILIDAD ---
        function triggerImportModal() { 
             if (appState.dataType !== 'json-csv') {
                 console.warn("[Importar] Intento de importar en un archivo no editable.");
                  showConfirmModal({title:"Acción no disponible", message:"Solo puedes importar datos en archivos JSON o CSV.", confirmText:"Entendido", confirmClass:"bg-yellow-600", onConfirm:()=>{}});
                 return;
             }
            showConfirmModal({
                title: 'Importar Archivo Local (Reemplazo)',
                message: 'Esto reemplazará todos tus cambios locales actuales con el contenido de un archivo .json o .csv de tu computadora. ¿Estás seguro?',
                note: 'Los cambios no se guardarán en GitHub hasta que presiones "Guardar Cambios".',
                confirmText: 'Sí, Importar y Reemplazar',
                confirmClass: 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-400',
                onConfirm: () => { document.getElementById('local-file-importer').click(); }
            });
         }
        async function handleLocalFileSelected(event) { 
            const file = event.target.files[0]; if (!file) return;
            const fileName = file.name; let parsedData;
            try {
                const content = await file.text();
                if (fileName.toLowerCase().endsWith('.json')) { parsedData = JSON.parse(content);
                } else if (fileName.toLowerCase().endsWith('.csv')) { parsedData = csvToJSON(content); 
                } else {
                    showConfirmModal({ title: "Error de Archivo", message: "Error: Tipo de archivo no compatible. Por favor, selecciona un .json o .csv.", confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                    return;
                }
                const isNewDataArray = Array.isArray(parsedData);
                const isNewDataObjectOfArrays = typeof parsedData === 'object' && parsedData !== null && !isNewDataArray && Object.keys(parsedData).length > 0 && Array.isArray(Object.values(parsedData)[0]);
                let importedStructureType = 'desconocida';
                if (isNewDataArray) importedStructureType = 'array';
                else if (isNewDataObjectOfArrays) importedStructureType = 'object-of-arrays';
                if (appState.dataStructure !== importedStructureType) {
                     showConfirmModal({ title: "Error de Estructura", message: `Error: La estructura del archivo original (${appState.dataStructure}) no coincide con la del archivo importado (${importedStructureType}). No se pueden mezclar.`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                    return;
                }
                console.log(`[Importar] Contenido de ${fileName} importado localmente.`);
                appState.data = parsedData; appState.isDirty = true;
                appState.pendingChangesLog = [`Importado contenido completo desde el archivo local: "${fileName}"`];
                analyzeDataStructure(); 
                renderApp(); renderEditor();
                showConfirmModal({ title: "Éxito de Importación", message: `¡Éxito! Contenido de "${fileName}" importado. Revisa los cambios y presiona "Guardar Cambios".`, confirmText: "Entendido", confirmClass: "bg-blue-600", onConfirm: () => {} });
            } catch (error) {
                console.error("[Importar] Error al importar archivo local:", error);
                showConfirmModal({ title: "Error al Importar", message: `Error al leer o parsear el archivo: ${error.message}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
            } finally { event.target.value = null; }
         }
        function getEmbeddableDriveUrl(url) { 
            if (!url || !url.includes('drive.google.com')) return '';
            const match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) { return `https://drive.google.com/file/d/${match[1]}/preview`; }
            return '';
         }
        function loadVideo(element) { 
            const url = element.dataset.embedUrl;
            if (url) {
                element.innerHTML = `<iframe src="${url}" class="w-full h-full border-0" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
                element.onclick = null;
                element.classList.remove('cursor-pointer', 'flex', 'items-center', 'justify-center');
            }
         }
        function triggerImageUpload(targetInputId) { 
             if (appState.dataType !== 'json-csv') { console.warn("[Subida Form] Intento de subir archivo fuera del modo editor JSON/CSV."); return; }
            appState.currentImageFieldTarget = targetInputId;
            document.getElementById('image-uploader-input').click();
         }
        async function handleImageUpload(event) { 
            const file = event.target.files[0];
            if (!file || !appState.currentImageFieldTarget) return;
            const fileName = `${Date.now()}-${file.name}`;
            const filePath = `uploads/${fileName}`;
            try {
                const base64Content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => { const base64 = reader.result.split(',')[1]; resolve(base64); };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
                console.log(`[Subida Form] Subiendo archivo: ${fileName}`);
                const endpoint = `/repos/${appState.selectedRepo}/contents/${filePath}`;
                const options = { method: 'PUT', body: JSON.stringify({ message: `Subido ${fileName} desde la plataforma (formulario)`, content: base64Content, }) };
                const result = await githubApiFetch(endpoint, options);
                 if (result === undefined) return;
                if (result && result.content && result.content.download_url) {
                    const downloadUrl = result.content.download_url;
                    console.log(`[Subida Form] Archivo subido. URL: ${downloadUrl}`);
                    document.getElementById(appState.currentImageFieldTarget).value = downloadUrl;
                    appState.isDirty = true;
                    appState.pendingChangesLog.push(`Archivo subido (formulario): "${fileName}"`);
                    renderApp(); 
                    showConfirmModal({ title: "Archivo Subido", message: `¡Archivo "${fileName}" subido con éxito! La URL ha sido añadida. No olvides guardar los cambios del JSON/CSV.`, confirmText: "Entendido", confirmClass: "bg-blue-600", onConfirm: () => {} });
                } else { throw new Error("La respuesta de GitHub no contenía la URL de descarga."); }
            } catch (error) {
                console.error("[Subida Form] Error al subir el archivo:", error);
                showConfirmModal({ title: "Error al Subir Archivo", message: `Error al subir el archivo: ${error.message}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
            } finally { event.target.value = null; appState.currentImageFieldTarget = null; }
         }
        function triggerGeneralFileUpload() { 
            const uploadLabel = document.getElementById('upload-file-label');
            const currentFolder = appState.currentPath || 'raíz';
            uploadLabel.textContent = `Subiendo a: /${currentFolder}`;
            document.getElementById('general-file-uploader').click();
         }
        async function handleGeneralFileUpload(event) { 
            const file = event.target.files[0]; if (!file) return;
            const fileName = `${Date.now()}-${file.name}`;
            const uploadPath = appState.currentPath || ''; 
            const filePath = uploadPath ? `${uploadPath}/${fileName}` : fileName; 
            try {
                const base64Content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => { const base64 = reader.result.split(',')[1]; resolve(base64); };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
                console.log(`[Subida General] Subiendo archivo a: ${filePath}`);
                const endpoint = `/repos/${appState.selectedRepo}/contents/${filePath}`;
                const options = { method: 'PUT', body: JSON.stringify({ message: `Subido ${fileName} desde la plataforma (general)`, content: base64Content, }) };
                const result = await githubApiFetch(endpoint, options);
                 if (result === undefined) return;
                if (result && result.content && result.content.download_url) {
                    const downloadUrl = result.content.download_url;
                    console.log(`[Subida General] Archivo subido. URL: ${downloadUrl}`);
                    showConfirmModal({ title: "Archivo Subido con Éxito", message: `Tu archivo "${fileName}" se subió a /${uploadPath}.\n\nPuedes copiar la URL:\n\n${downloadUrl}`, note: "Pega esta URL en cualquier campo de texto.", confirmText: "¡Entendido!", confirmClass: "bg-blue-600", onConfirm: () => {} });
                    loadRepoPath(appState.currentPath);
                } else { throw new Error("La respuesta de GitHub no contenía la URL de descarga."); }
            } catch (error) {
                console.error("[Subida General] Error al subir el archivo:", error);
                showConfirmModal({ title: "Error al Subir Archivo", message: `Error al subir el archivo: ${error.message}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
            } finally {
                event.target.value = null;
                const uploadLabel = document.getElementById('upload-file-label');
                const currentFolder = appState.currentPath || 'raíz';
                uploadLabel.textContent = `Subir Archivo a: /${currentFolder}`;
            }
         }
        function csvToJSON(csvString) { 
            const result = Papa.parse(csvString, { header: true, skipEmptyLines: true, dynamicTyping: true });
            if (result.errors.length > 0) {
                console.error("[CSV] Errores de PapaParse (CSV a JSON):", result.errors);
                 throw new Error(`Error al leer el CSV: ${result.errors[0].message}`);
            }
            return result.data;
         }
        function jsonToCSV(jsonArray) { 
             if (!jsonArray || jsonArray.length === 0) return '';
             if (!Array.isArray(jsonArray) || !jsonArray.every(item => typeof item === 'object' && item !== null)) {
                 console.error("[CSV] Error: jsonToCSV recibió datos que no son un array de objetos.");
                  showConfirmModal({title:"Error al Guardar", message:"Los datos no tienen el formato correcto (array de objetos) para guardarse como CSV.", confirmText:"Entendido", confirmClass:"bg-red-600", onConfirm:()=>{}});
                 return ''; 
             }
            try { return Papa.unparse(jsonArray); } 
            catch (error) {
                console.error("[CSV] Error de PapaParse (JSON a CSV):", error);
                showConfirmModal({ title: "Error de CSV", message: `Error al convertir a CSV: ${error.message}`, confirmText: "Entendido", confirmClass: "bg-red-600", onConfirm: () => {} });
                return ''; 
            }
         }
        function showConfirmModal({ title, message, note, confirmText, confirmClass, onConfirm }) { 
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            const noteEl = document.getElementById('confirm-modal-note');
            if (note) { noteEl.textContent = note; noteEl.classList.remove('hidden'); } 
            else { noteEl.classList.add('hidden'); }
            const acceptBtn = document.getElementById('confirm-modal-accept-btn');
            acceptBtn.textContent = confirmText;
            acceptBtn.className = 'px-4 py-2 text-white rounded-md shadow-sm focus:outline-none focus:ring-2'; 
             acceptBtn.classList.add(...confirmClass.split(' '));
            const newAcceptBtn = acceptBtn.cloneNode(true); 
            newAcceptBtn.onclick = () => {
                hideConfirmModal(); 
                if (typeof onConfirm === 'function') { onConfirm(); } 
                else { console.warn("[Modal] onConfirm no era una función:", onConfirm); }
            };
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
            document.getElementById('confirm-modal').classList.remove('hidden');
         }
        function hideConfirmModal() { 
            document.getElementById('confirm-modal').classList.add('hidden');
         }
        function showInputModal({ title, message, defaultValue = '', confirmText, confirmClass, onConfirm }) {
            document.getElementById('input-modal-title').textContent = title;
            document.getElementById('input-modal-message').textContent = message;
            const inputField = document.getElementById('input-modal-field');
            inputField.value = defaultValue;
            inputField.placeholder = defaultValue; 
            const acceptBtn = document.getElementById('input-modal-accept-btn');
            acceptBtn.textContent = confirmText;
            acceptBtn.className = 'px-4 py-2 text-white rounded-md shadow-sm focus:outline-none focus:ring-2'; 
            acceptBtn.classList.add(...confirmClass.split(' '));
            const newAcceptBtn = acceptBtn.cloneNode(true); 
            newAcceptBtn.onclick = () => {
                const value = inputField.value.trim(); 
                if (value) { 
                     hideInputModal(); 
                     if (typeof onConfirm === 'function') { onConfirm(value); }
                } else { inputField.focus(); }
            };
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
            document.getElementById('input-modal').classList.remove('hidden');
            inputField.focus(); 
        }
        function hideInputModal() {
            document.getElementById('input-modal').classList.add('hidden');
            document.getElementById('input-modal-field').value = ''; 
        }
        window.addEventListener('beforeunload', (event) => { 
            if (appState.isDirty) {
                console.warn('[App] Intento de cierre con cambios sin guardar.');
                event.preventDefault();
                event.returnValue = ''; 
            }
         });

        // --- INICIO DE LA APP ---
        window.app = {
            handleLogin, logout, goBackToBrowser, handleRepoChange, 
            loadRepoPath, loadFileContent, 
            showEditModal, hideEditModal, handleEditItem, 
            showDeleteConfirmation, handleDeleteItem, handleAddItem, 
            showDeleteFileConfirmation, handleDeleteFile,
            showDuplicateFileModal, handleDuplicateFile, 
            showSchemaModal, hideSchemaModal, handleAddField,
            saveAllChanges, _reallySaveAllChanges, showReviewChangesModal, hideReviewChangesModal, 
            showCodeEditor, hideCodeEditor, handleSaveCodeFile,
            triggerImportModal, handleLocalFileSelected, 
            triggerImageUpload, handleImageUpload, triggerGeneralFileUpload, handleGeneralFileUpload,
            hideConfirmModal, hideInputModal, 
            loadVideo, renderItemsList 
        };

        initializeApp();
    </script>

</body>
</html>

